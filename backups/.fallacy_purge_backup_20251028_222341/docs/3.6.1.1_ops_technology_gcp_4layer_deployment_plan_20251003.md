# GCP 4-LAYER DEPLOYMENT PLAN - SESSION-BY-SESSION ROLLOUT

**Created:** October 3, 2025, 07:42 AM PDT
**Owner:** Jesse Niesen / RND Technology
**Project:** LivHana E2E Empire - Google Cloud Production Deployment
**Timeline:** 4 sessions (est. 8-12 hours total)
**Objective:** Launch all 4 business layers working together on Google Cloud

---

## EXECUTIVE SUMMARY

**Current State:** GitHub perfect ✅ | Code production-ready ✅ | Local development complete ✅
**Target State:** 4-layer cloud architecture running on Google Cloud Platform
**Deployment Model:** Session-by-session incremental rollout with verification gates

**4 Business Layers:**

1. **Frontend Layer** - Next.js vibe-cockpit + static sites
2. **Backend Services Layer** - Microservices (integration, payment, reasoning)
3. **Data Layer** - BigQuery + PostgreSQL + Redis
4. **AI/ML Layer** - Voice agent + reasoning gateway + content engine

---

## ARCHITECTURE OVERVIEW

### Layer 1: Frontend Layer (Cloud Run + Cloud Storage)

```
┌─────────────────────────────────────────────────────────────┐
│ FRONTEND LAYER - Next.js + Static Sites                    │
├─────────────────────────────────────────────────────────────┤
│ • Cloud Run: vibe-cockpit (Next.js SSR)                    │
│ • Cloud Storage: Static sites (69 domains)                 │
│ • Cloud CDN: Global content delivery                       │
│ • Cloud Load Balancer: SSL termination + routing          │
├─────────────────────────────────────────────────────────────┤
│ Domains:                                                    │
│ - reggieanddro.com (primary)                              │
│ - herbitrage.com                                           │
│ - oneplantsolution.com                                     │
│ - highnooncartoon.com                                      │
│ - + 65 more empire domains                                 │
└─────────────────────────────────────────────────────────────┘
```

### Layer 2: Backend Services Layer (Cloud Run + GKE)

```
┌─────────────────────────────────────────────────────────────┐
│ BACKEND SERVICES LAYER - Microservices                     │
├─────────────────────────────────────────────────────────────┤
│ integration-service (Cloud Run)                             │
│ ├── LightSpeed POS sync (every 15 min)                     │
│ ├── Leafly API sync (every 30 min)                         │
│ ├── Square catalog sync                                     │
│ ├── Age verification (Veriff)                              │
│ └── BigQuery data warehouse                                │
│                                                             │
│ payment-service (Cloud Run)                                 │
│ ├── KAJA/Authorize.Net (cannabis-compliant)               │
│ ├── Age verification (21+)                                 │
│ ├── State compliance checks                                │
│ └── PCI DSS compliant                                      │
│                                                             │
│ reasoning-gateway (Cloud Run)                               │
│ ├── Claude Sonnet API gateway                             │
│ ├── Autonomous agent orchestration                         │
│ └── Self-improvement loops                                 │
│                                                             │
│ cannabis-service (Cloud Run)                                │
│ ├── Product catalog                                        │
│ ├── COA validation                                         │
│ └── Compliance reporting                                   │
└─────────────────────────────────────────────────────────────┘
```

### Layer 3: Data Layer (BigQuery + Cloud SQL + Memorystore)

```
┌─────────────────────────────────────────────────────────────┐
│ DATA LAYER - Databases + Cache + Warehouse                 │
├─────────────────────────────────────────────────────────────┤
│ BigQuery (Data Warehouse)                                   │
│ ├── cannabis_data dataset                                  │
│ │   ├── lightspeed_menu                                    │
│ │   ├── leafly_menu                                        │
│ │   ├── leafly_deals                                       │
│ │   ├── leafly_products                                    │
│ │   └── square_catalog                                     │
│ └── compliance_data dataset                                │
│     ├── transactions                                        │
│     ├── age_verifications                                  │
│     └── audit_logs                                         │
│                                                             │
│ Cloud SQL (PostgreSQL)                                      │
│ ├── users                                                   │
│ ├── orders                                                  │
│ ├── inventory                                              │
│ └── sessions                                               │
│                                                             │
│ Memorystore (Redis)                                         │
│ ├── Rate limiting                                          │
│ ├── Session cache                                          │
│ └── API response cache                                     │
└─────────────────────────────────────────────────────────────┘
```

### Layer 4: AI/ML Layer (Cloud Run + Vertex AI)

```
┌─────────────────────────────────────────────────────────────┐
│ AI/ML LAYER - Voice + Content + Reasoning                  │
├─────────────────────────────────────────────────────────────┤
│ voice-service (Cloud Run)                                   │
│ ├── OpenAI TTS (voice generation)                         │
│ ├── Voice agent orchestration                              │
│ └── Real-time audio streaming                             │
│                                                             │
│ content-engine (Cloud Run)                                  │
│ ├── OpenAI DALL-E 3 (image generation)                    │
│ ├── Video composition (ffmpeg)                            │
│ ├── Text-to-video pipeline                                │
│ └── High Noon Cartoon content                             │
│                                                             │
│ reasoning-gateway (Cloud Run)                               │
│ ├── Claude Sonnet 4.5 integration                         │
│ ├── Autonomous decision engine                            │
│ └── Self-healing automation                               │
└─────────────────────────────────────────────────────────────┘
```

---

## SESSION-BY-SESSION DEPLOYMENT PLAN

### SESSION 1: Infrastructure Foundation + Frontend Layer (2-3 hours)

**Goal:** GCP project setup + Frontend layer live

#### Pre-Session Requirements

- [ ] Google Cloud account with billing enabled
- [ ] Domain DNS configured (Cloudflare → Cloud Load Balancer)
- [ ] GitHub repository access configured
- [ ] Service account keys generated

#### Tasks

1. **GCP Project Setup** (30 min)

   ```bash
   # Create project
   gcloud projects create livhana-production
   gcloud config set project livhana-production

   # Enable APIs
   gcloud services enable compute.googleapis.com
   gcloud services enable run.googleapis.com
   gcloud services enable cloudbuild.googleapis.com
   gcloud services enable bigquery.googleapis.com
   gcloud services enable sqladmin.googleapis.com
   gcloud services enable redis.googleapis.com
   ```

2. **Frontend Layer Deployment** (90 min)
   - Build vibe-cockpit Docker image
   - Deploy to Cloud Run
   - Configure Cloud Load Balancer
   - Set up Cloud CDN
   - Deploy static sites to Cloud Storage
   - Configure SSL certificates (managed by Google)

3. **Verification** (30 min)
   - [ ] <https://reggieanddro.com> responds (Cloudflare → Cloud Run)
   - [ ] vibe-cockpit dashboard loads
   - [ ] SSL certificate valid
   - [ ] CDN cache working

**Deliverables:**

- Frontend layer live on Cloud Run
- Load balancer configured
- SSL certificates active
- Static sites deployed

---

### SESSION 2: Backend Services Layer + Data Foundation (3-4 hours)

**Goal:** All backend microservices + databases operational

#### Tasks

1. **Data Layer Setup** (60 min)

   ```bash
   # BigQuery datasets
   bq mk --dataset livhana-production:cannabis_data
   bq mk --dataset livhana-production:compliance_data

   # Cloud SQL (PostgreSQL)
   gcloud sql instances create livhana-db \
     --database-version=POSTGRES_15 \
     --tier=db-f1-micro \
     --region=us-central1

   # Memorystore (Redis)
   gcloud redis instances create livhana-cache \
     --size=1 \
     --region=us-central1
   ```

2. **Backend Services Deployment** (120 min)
   - Build Docker images for all services
   - Deploy integration-service
   - Deploy payment-service
   - Deploy reasoning-gateway
   - Deploy cannabis-service
   - Configure environment variables
   - Set up service-to-service authentication

3. **Integration Testing** (60 min)
   - [ ] LightSpeed sync working
   - [ ] KAJA/Authorize.Net payment flow
   - [ ] BigQuery data flowing
   - [ ] Redis cache operational

**Deliverables:**

- 4 backend services live
- Databases operational
- Service mesh configured
- All integrations verified

---

### SESSION 3: AI/ML Layer + E2E Integration (2-3 hours)

**Goal:** AI services live + full E2E flow working

#### Tasks

1. **AI/ML Services Deployment** (90 min)
   - Deploy voice-service (OpenAI TTS)
   - Deploy content-engine (DALL-E 3 + ffmpeg)
   - Deploy reasoning-gateway (Claude Sonnet)
   - Configure API keys (OpenAI, Anthropic)
   - Set up Cloud Storage for media assets

2. **E2E Integration Testing** (60 min)
   - [ ] Frontend → Backend → Data flow
   - [ ] Payment processing end-to-end
   - [ ] LightSpeed → Leafly → Frontend sync
   - [ ] Voice agent functional
   - [ ] Content generation working

3. **Monitoring Setup** (30 min)
   - Cloud Logging configured
   - Cloud Monitoring dashboards
   - Uptime checks
   - Error alerting

**Deliverables:**

- All 4 layers operational
- E2E flow verified
- Monitoring active
- Alerts configured

---

### SESSION 4: Production Hardening + Empire Scaling (2-3 hours)

**Goal:** Production-ready with autoscaling + 69 domains live

#### Tasks

1. **Production Hardening** (60 min)
   - Enable Cloud Armor (DDoS protection)
   - Configure autoscaling policies
   - Set up backup jobs
   - Enable audit logging
   - Configure secrets rotation

2. **Empire Domain Deployment** (90 min)
   - Deploy all 69 domains
   - Configure domain routing
   - Set up SSL certificates (bulk)
   - Test each domain endpoint

3. **Final Verification** (30 min)
   - [ ] All services responding
   - [ ] Load testing passed
   - [ ] Security scan passed
   - [ ] PCI compliance verified
   - [ ] All 69 domains live

**Deliverables:**

- Production-ready system
- All 69 domains operational
- Autoscaling configured
- Security hardened

---

## TECHNICAL SPECIFICATIONS

### Service Resources (Cloud Run)

| Service | CPU | Memory | Max Instances | Startup |
|---------|-----|--------|---------------|---------|
| vibe-cockpit | 2 | 2Gi | 10 | Cold |
| integration-service | 1 | 1Gi | 5 | Warm (min 1) |
| payment-service | 1 | 512Mi | 10 | Warm (min 1) |
| reasoning-gateway | 2 | 2Gi | 3 | Cold |
| cannabis-service | 1 | 512Mi | 5 | Cold |
| voice-service | 1 | 1Gi | 3 | Cold |
| content-engine | 2 | 4Gi | 2 | Cold |

### Database Sizing

**Cloud SQL (PostgreSQL)**

- Tier: db-f1-micro (1 vCPU, 0.6GB RAM) → Start small
- Storage: 10GB SSD (auto-expand enabled)
- Backups: Daily automated
- HA: Single-zone (upgrade to multi-zone in production)

**Memorystore (Redis)**

- Tier: Basic (1GB)
- Region: us-central1
- Replication: None initially

**BigQuery**

- On-demand pricing
- Datasets: cannabis_data, compliance_data
- Partitioned tables by date

---

## ENVIRONMENT VARIABLES (Cloud Run)

### integration-service

```bash
LIGHTSPEED_API_KEY=<from_1password>
LIGHTSPEED_ACCOUNT_ID=<from_1password>
LIGHTSPEED_SYNC_SCHEDULE="*/15 * * * *"

LEAFLY_API_KEY=<from_business.leafly.com>
LEAFLY_DISPENSARY_ID=<from_leafly>
LEAFLY_SYNC_SCHEDULE="*/30 * * * *"

BIGQUERY_PROJECT_ID=livhana-production
BIGQUERY_DATASET=cannabis_data

REDIS_HOST=<memorystore_ip>
REDIS_PORT=6379
```

### payment-service

```bash
AUTHORIZE_NET_API_LOGIN_ID=<merchant_56617929051577>
AUTHORIZE_NET_TRANSACTION_KEY=<from_authorize_net>
AUTHORIZE_NET_SANDBOX=false

DATABASE_URL=postgresql://<cloud_sql_connection>
REDIS_HOST=<memorystore_ip>
```

### reasoning-gateway

```bash
ANTHROPIC_API_KEY=<from_anthropic>
OPENAI_API_KEY=<from_openai>
MODEL=claude-sonnet-4-5-20250929
```

### voice-service

```bash
OPENAI_API_KEY=<from_openai>
TTS_MODEL=tts-1-hd
TTS_VOICE=alloy
```

### content-engine

```bash
OPENAI_API_KEY=<from_openai>
DALLE_MODEL=dall-e-3
DALLE_SIZE=1792x1024
DALLE_QUALITY=hd

STORAGE_BUCKET=livhana-content-assets
```

---

## COST ESTIMATION (Monthly)

### Compute (Cloud Run)

- vibe-cockpit: $50-100 (10k requests/day)
- integration-service: $30-50 (warm instance + scheduled jobs)
- payment-service: $30-50 (warm instance + PCI compliance)
- reasoning-gateway: $20-40 (cold start, low traffic)
- cannabis-service: $20-30 (cold start)
- voice-service: $15-25 (cold start)
- content-engine: $25-40 (high memory)
**Subtotal:** $190-335/month

### Data Layer

- Cloud SQL: $15-25 (db-f1-micro)
- Memorystore: $30-40 (1GB Basic)
- BigQuery: $20-50 (on-demand queries)
**Subtotal:** $65-115/month

### Network & Storage

- Cloud Load Balancer: $18/month
- Cloud CDN: $20-50 (depends on traffic)
- Cloud Storage: $5-15 (static assets)
- Egress: $50-100 (depends on traffic)
**Subtotal:** $93-183/month

### AI/ML APIs (External)

- OpenAI (TTS + DALL-E): $100-200/month
- Anthropic (Claude Sonnet): $50-150/month
**Subtotal:** $150-350/month

### **TOTAL ESTIMATED COST: $498-983/month**

**Optimization Target:** $500-700/month with usage optimization

---

## SECURITY & COMPLIANCE

### PCI DSS Requirements

- [ ] Payment service isolated (separate Cloud Run service)
- [ ] No card data stored (tokenization only)
- [ ] TLS 1.3 enforced
- [ ] Audit logging enabled
- [ ] Quarterly vulnerability scans (PCI Protection)
- [ ] Network segmentation (VPC Service Controls)

### Cannabis Compliance

- [ ] Age verification (21+) enforced
- [ ] State compliance checks active
- [ ] Transaction audit trail (BigQuery)
- [ ] Data retention policies (7 years)

### Security Hardening

- [ ] Cloud Armor DDoS protection
- [ ] Identity-Aware Proxy (IAP) for admin
- [ ] Secret Manager for credentials
- [ ] VPC Service Controls
- [ ] Cloud Audit Logs enabled
- [ ] Binary Authorization (signed containers)

---

## MONITORING & ALERTING

### Cloud Monitoring Dashboards

1. **Service Health Dashboard**
   - Request rate per service
   - Error rate (4xx, 5xx)
   - Latency (p50, p95, p99)
   - Instance count

2. **Business Metrics Dashboard**
   - Orders per hour
   - Payment success rate
   - LightSpeed sync status
   - Leafly sync status
   - Age verification pass rate

3. **Cost Dashboard**
   - Compute costs by service
   - Data transfer costs
   - API costs (OpenAI, Anthropic)

### Alerts

- [ ] Error rate > 5% (critical)
- [ ] Latency p99 > 5s (warning)
- [ ] Service down (critical)
- [ ] Database connection failures (critical)
- [ ] Payment failures > 10% (critical)
- [ ] Daily cost spike > 20% (warning)

---

## ROLLBACK PLAN

### Per-Session Rollback

- **Session 1:** Delete Cloud Run services, revert DNS
- **Session 2:** Stop Cloud SQL, delete Cloud Run services
- **Session 3:** Delete AI services, revert integrations
- **Session 4:** Revert domain routing

### Emergency Rollback (Production)

```bash
# Revert to previous Cloud Run revision
gcloud run services update-traffic vibe-cockpit \
  --to-revisions=PREVIOUS_REVISION=100

# Scale down to zero
gcloud run services update vibe-cockpit --min-instances=0
```

---

## SUCCESS CRITERIA

### Session 1 Success

- [ ] Frontend accessible at <https://reggieanddro.com>
- [ ] SSL certificate valid
- [ ] Load balancer operational
- [ ] CDN cache hit ratio > 80%

### Session 2 Success

- [ ] All backend services respond to health checks
- [ ] Database connections stable
- [ ] LightSpeed sync running every 15 min
- [ ] Redis cache operational

### Session 3 Success

- [ ] Voice generation working
- [ ] Content generation working
- [ ] E2E payment flow complete
- [ ] Monitoring dashboards live

### Session 4 Success

- [ ] All 69 domains responding
- [ ] Autoscaling triggered under load
- [ ] Security scan passed
- [ ] Cost within $700/month target

---

## NEXT STEPS

### Immediate (This Session)

1. ✅ Create this deployment plan
2. Document Dockerfile for each service
3. Create Cloud Build configuration
4. Generate environment variable templates

### Before Session 1

1. Verify Google Cloud billing account
2. Obtain all API keys (Leafly, OpenAI, Anthropic)
3. Complete PCI vulnerability scan
4. Configure Cloudflare DNS for Cloud Load Balancer

### Session 1 Prep

1. Create service account keys
2. Set up gcloud CLI authentication
3. Clone repository on deployment machine
4. Review Dockerfiles

---

**Status:** PLAN COMPLETE - READY FOR SESSION 1 EXECUTION
**Owner:** Jesse Niesen
**Approver:** Commander Codex
**Standard:** Liv Hana ABSOLUTE - 100% TRUE, TIER 1

🦄 Generated with Claude Sonnet 4.5 - TIER 1 - Always Higher
