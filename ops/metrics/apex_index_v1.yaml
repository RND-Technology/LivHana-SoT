# APEX INDEX v1.0 — PRIORITIZATION OS
## Herbitrage-Powered Experiment Selection & Risk Scoring

version: "1.0"
created: "2025-10-06"
status: "production"
owner: "Liv Hana - Herbitrage Terminal"
compliance: "THCASOP, NIST, CR, 21+"

---

## PURPOSE
Prioritize experiments, products, and merchants by composite score that balances:
- Economic value (ROI/$/Day)
- User consent & trust
- Compliance & safety
- Experience quality
- Margin recoverability

**Goal**: Maximize durable profit for users + brands + Liv Hana while maintaining 100% compliance.

---

## FORMULA

```yaml
apex_index:
  formula: "weighted_composite"
  range: [0, 100]

  components:
    - name: "roi_per_day"
      weight: 0.35
      source: "herbitrage_terminal"
      calculation: "(revenue - cost) / days_active"

    - name: "consent_weighted_purchase_intent"
      weight: 0.20
      source: "lss_truth_panel_analytics"
      calculation: "(ctr_to_truth_panel * add_to_cart_via_lss) / total_views"

    - name: "trust_receipts_score"
      weight: 0.15
      source: "receipts_first_kb"
      calculation: "avg(coa_match_rate, recall_history_score, vendor_dispute_rate_inverse)"

    - name: "compliance_score"
      weight: 0.15
      source: "thcasop_filter + nist_validator"
      calculation: "sum(age_gate, coa_available, nist_validated, cr_packaging) / 4 * 100"

    - name: "experience_delta"
      weight: 0.10
      source: "lss_comparison_engine"
      calculation: "avg(shipping_speed_score, returns_ease_score, support_rating)"

    - name: "margin_recoverability"
      weight: 0.05
      source: "rvs_calculator"
      calculation: "(marketplace_fee_avoided + ad_tax_avoided) * confidence_multiplier"

  gates:
    - condition: "compliance_score < 80"
      action: "reject"
      reason: "Safety/legal risk too high"

    - condition: "trust_receipts_score < 70"
      action: "reject"
      reason: "Vendor reputation insufficient"

    - condition: "roi_per_day < 0"
      action: "flag_for_review"
      reason: "Negative economics"
```

---

## COMPONENT DEFINITIONS

### 1. ROI/$/Day (Herbitrage Base)
```yaml
roi_per_day:
  description: "Daily profit generated by experiment/product/merchant"

  inputs:
    revenue:
      - subscription_fees
      - transaction_fees_collected
      - data_licensing_revenue
      - cashback_recovered_value_share  # 30% of RV

    costs:
      - ai_api_costs  # Claude, DeepSeek, OpenAI
      - infrastructure_costs  # GCP, Vertex AI
      - payment_processing_fees  # Stripe, Agent Pay
      - cashback_payouts  # 50% of RV
      - brand_share  # 20% of RV

    days_active:
      - calendar_days_since_launch

  calculation: |
    roi_per_day = (sum(revenue) - sum(costs)) / days_active

  scoring:
    range: [-∞, +∞]
    normalization: "sigmoid(roi_per_day / 10) * 100"  # Scale to 0-100

  herbitrage_integration:
    source: "herbitrage_terminal.experiments.roi_$/day"
    update_frequency: "daily"
    audit_trail: true
```

### 2. Consent-Weighted Purchase Intent
```yaml
consent_weighted_purchase_intent:
  description: "User engagement with Truth Panel that leads to purchases"

  inputs:
    ctr_to_truth_panel:
      description: "% of product page views where user opens Truth Panel"
      source: "lss_analytics.overlay_trigger_rate"

    add_to_cart_via_lss:
      description: "% of Truth Panel views that result in 'Buy Direct' click"
      source: "lss_analytics.buy_direct_button_clicks"

    total_views:
      description: "Total product page impressions"
      source: "lss_analytics.page_views"

  calculation: |
    intent_score = (ctr_to_truth_panel * add_to_cart_via_lss) / total_views * 100

    # Example:
    # 1,000 page views
    # 120 Truth Panel opens (12% CTR)
    # 96 Buy Direct clicks (80% conversion)
    # Intent Score = (0.12 * 0.80) / 1 * 100 = 9.6/100

  scoring:
    range: [0, 100]
    target: ">= 8"  # 8% combined intent rate

  privacy:
    anonymization: "aggregate_only"
    min_sample_size: 1000
```

### 3. Trust/Receipts Score
```yaml
trust_receipts_score:
  description: "Vendor reliability based on verifiable receipts"

  inputs:
    coa_match_rate:
      description: "% of products with COAs that match label claims"
      source: "receipts_first_kb.coa_validation"
      calculation: "matching_coas / total_coas * 100"

    recall_history_score:
      description: "Inverse of recall frequency"
      source: "receipts_first_kb.recall_history"
      calculation: "100 - (recalls_last_12mo / total_products * 100)"

    vendor_dispute_rate_inverse:
      description: "100 minus % of orders disputed"
      source: "receipts_first_kb.dispute_log"
      calculation: "100 - (disputes / total_orders * 100)"

  calculation: |
    trust_score = avg(coa_match_rate, recall_history_score, vendor_dispute_rate_inverse)

    # Example:
    # COA Match: 95%
    # Recall History: 100% (zero recalls)
    # Dispute Rate: 0.5% → Inverse = 99.5%
    # Trust Score = (95 + 100 + 99.5) / 3 = 98.2/100

  scoring:
    range: [0, 100]
    gate: ">= 70"  # Minimum acceptable trust

  data_sources:
    - texas_coa_checker
    - kca_labs_database
    - dshs_inspection_records
    - member_dispute_log
```

### 4. Compliance Score
```yaml
compliance_score:
  description: "Adherence to THCASOP + state regulations"

  inputs:
    age_gate_enforced:
      description: "21+ verification active"
      source: "thcasop_filter.age_gate"
      binary: [0, 100]

    coa_available:
      description: "Certificate of Analysis provided"
      source: "thcasop_filter.coa_check"
      binary: [0, 100]

    nist_validated:
      description: "Lab methods NIST-compliant"
      source: "nist_validator.method_check"
      binary: [0, 100]

    cr_packaging:
      description: "Child-resistant packaging used"
      source: "thcasop_filter.cr_check"
      binary: [0, 100]

  calculation: |
    compliance_score = sum(age_gate, coa, nist, cr) / 4 * 100

    # Example (all compliant):
    # Age Gate: 100
    # COA: 100
    # NIST: 100
    # CR: 100
    # Score = 400 / 4 = 100

    # Example (missing COA):
    # Age Gate: 100
    # COA: 0
    # NIST: 100
    # CR: 100
    # Score = 300 / 4 = 75

  scoring:
    range: [0, 100]
    gate: ">= 80"  # Minimum acceptable compliance

  enforcement:
    zero_tolerance_violations:
      - minor_accessed
      - medical_claim_made
      - recalled_product_sold
    action: "immediate_removal_from_platform"
```

### 5. Experience Delta
```yaml
experience_delta:
  description: "Quality difference: direct vs marketplace"

  inputs:
    shipping_speed_score:
      source: "lss_comparison_engine.shipping_analysis"
      calculation: |
        direct_days = avg_shipping_time_direct
        marketplace_days = avg_shipping_time_marketplace
        if direct_days < marketplace_days:
          score = 100
        elif direct_days == marketplace_days:
          score = 70
        else:
          score = 40

    returns_ease_score:
      source: "lss_comparison_engine.returns_analysis"
      factors:
        - return_window_days
        - restocking_fee
        - customer_service_rating
      calculation: "weighted_avg(factors)"

    support_rating:
      source: "receipts_first_kb.support_reviews"
      calculation: "avg_star_rating / 5 * 100"

  calculation: |
    experience_score = avg(shipping_score, returns_score, support_rating)

  scoring:
    range: [0, 100]
    target: ">= 80"  # Direct should be better or equal
```

### 6. Margin Recoverability
```yaml
margin_recoverability:
  description: "How much fee/ad-tax can be documented and shared"

  inputs:
    marketplace_fee_avoided:
      source: "rvs_calculator.marketplace_fee_data"
      examples:
        amazon_referral_fee: "8-15%"  # Category-dependent
        ebay_final_value_fee: "10-12%"
        etsy_transaction_fee: "6.5%"
      calculation: "product_price * fee_percentage"

    ad_tax_avoided:
      source: "rvs_calculator.ad_cost_estimates"
      examples:
        google_ads_cpc: "$20-100"  # Cannabis keywords
        facebook_cpm: "$15-50"
        dtc_cac_percentage: "10-20% of revenue"
      calculation: "product_price * estimated_cac_percentage"

    confidence_multiplier:
      description: "Attribution confidence (0-1)"
      factors:
        - affiliate_link_used: 1.0  # Direct attribution
        - coupon_code_used: 0.9
        - utm_parameter_tracked: 0.8
        - estimated_baseline: 0.5

  calculation: |
    recovered_value = (marketplace_fee + ad_tax) * confidence
    margin_score = (recovered_value / product_price) * 100

    # Example:
    # Product: $50
    # Amazon fee avoided: $6 (12%)
    # Ad-tax avoided: $7.50 (15%)
    # Confidence: 0.9 (coupon code)
    # RV = ($6 + $7.50) * 0.9 = $12.15
    # Margin Score = ($12.15 / $50) * 100 = 24.3/100

  scoring:
    range: [0, 100]
    normalization: "min(margin_score, 30) / 30 * 100"  # Cap at 30%

  rvs_split:
    user_cashback: 0.50
    liv_hana: 0.30
    brand_discount: 0.20
```

---

## COMPOSITE CALCULATION EXAMPLE

### Sample Product: Cheetah Piss THCa ($50)
```yaml
inputs:
  roi_per_day:
    revenue: 15  # $15/day from this product (subscription + transaction fees)
    costs: 8     # $8/day (AI, infra, cashback, brand share)
    days_active: 30
    raw_value: 0.23  # ($15 - $8) / 30
    normalized: 68   # sigmoid(0.23 / 10) * 100

  consent_purchase_intent:
    ctr_to_truth_panel: 0.14  # 14%
    add_to_cart_via_lss: 0.82  # 82%
    intent_score: 11.5  # (0.14 * 0.82) * 100
    normalized: 11.5

  trust_receipts:
    coa_match: 98
    recall_history: 100
    dispute_rate_inverse: 99.8
    trust_score: 99.3

  compliance:
    age_gate: 100
    coa: 100
    nist: 100
    cr: 100
    compliance_score: 100

  experience_delta:
    shipping: 100  # 2 days direct vs 3-5 marketplace
    returns: 90    # 30-day vs 30-day, but easier process
    support: 96    # 4.8/5 stars
    experience_score: 95

  margin_recoverability:
    marketplace_fee: 6       # $6 (12% Amazon)
    ad_tax: 7.50            # $7.50 (15% DTC CAC)
    confidence: 0.9         # Coupon code used
    recovered_value: 12.15  # ($6 + $7.50) * 0.9
    margin_score: 24.3      # ($12.15 / $50) * 100
    normalized: 81          # (24.3 / 30) * 100

calculation:
  apex_index = (68 * 0.35) + (11.5 * 0.20) + (99.3 * 0.15) + (100 * 0.15) + (95 * 0.10) + (81 * 0.05)
  apex_index = 23.8 + 2.3 + 14.9 + 15.0 + 9.5 + 4.05
  apex_index = 69.55 / 100

gates:
  compliance: 100 >= 80  ✅ PASS
  trust: 99.3 >= 70      ✅ PASS
  roi: 0.23 >= 0         ✅ PASS

result:
  apex_index: 69.55
  status: "APPROVED"
  priority: "HIGH"  # 60-80 range
  action: "scale_marketing_budget"
```

---

## SCORING TIERS

```yaml
tiers:
  critical:
    range: [80, 100]
    label: "CRITICAL - Scale Immediately"
    action: "allocate_max_resources"
    frequency: "daily_review"

  high:
    range: [60, 79]
    label: "HIGH - Invest Aggressively"
    action: "increase_budget_30_percent"
    frequency: "weekly_review"

  medium:
    range: [40, 59]
    label: "MEDIUM - Maintain Current Level"
    action: "hold_budget_steady"
    frequency: "biweekly_review"

  low:
    range: [20, 39]
    label: "LOW - Monitor for Improvement"
    action: "reduce_budget_or_sunset"
    frequency: "monthly_review"

  reject:
    range: [0, 19]
    label: "REJECT - Do Not Launch"
    action: "remove_from_platform"
    frequency: "n/a"
```

---

## HERBITRAGE GREEKS INTEGRATION

```yaml
greeks:
  description: "Use Herbitrage Greeks to stress-test Apex Index under different scenarios"

  delta:
    description: "Sensitivity to price changes"
    calculation: "d(apex_index) / d(product_price)"
    use_case: "How much does Apex Index drop if price increases 10%?"

  theta:
    description: "Time decay of advantage"
    calculation: "d(apex_index) / d(time)"
    use_case: "How fast does competitive advantage erode?"

  gamma:
    description: "Rate of change of Delta"
    calculation: "d²(apex_index) / d(product_price)²"
    use_case: "At what price point does advantage accelerate?"

  vega:
    description: "Sensitivity to market volatility"
    calculation: "d(apex_index) / d(market_volatility)"
    use_case: "How resilient is advantage during market chaos?"

stress_tests:
  - scenario: "Competitor launches identical product at -20% price"
    impact_on_apex: "-15 points"
    mitigation: "Increase cashback share to 60%"

  - scenario: "Amazon bans cannabis keywords (zero ad-tax avoidable)"
    impact_on_apex: "-3 points"  # Only 5% weight
    mitigation: "Focus on marketplace fee avoidance + trust score"

  - scenario: "COA falsification scandal (trust drops to 40)"
    impact_on_apex: "GATE FAILURE"
    mitigation: "Immediate vendor removal + public transparency report"
```

---

## AUDIT TRAIL

```yaml
audit_trail:
  required_fields:
    - timestamp: "ISO-8601"
    - product_sku: "string"
    - merchant_id: "string"
    - apex_index_score: "number"
    - component_scores: "object"
    - gates_passed: "boolean"
    - decision: "string"  # APPROVED, REJECTED, FLAGGED
    - reviewer: "string"  # human or "autonomous_agent"

  storage:
    location: "receipts_first_kb.apex_index_audit"
    retention: "7 years"  # Compliance requirement
    encryption: "AES-256"

  public_ledger:
    publish_weekly: true
    aggregation: "category_level"  # No individual products
    min_sample_size: 100
    format: "markdown + csv"
    location: "https://livhana.com/apex-index/weekly-report"
```

---

## DEPLOYMENT

```yaml
deployment:
  phase_1:
    timeline: "T+30 days"
    scope: "20 pilot products"
    automation: "manual_review"
    frequency: "weekly"

  phase_2:
    timeline: "T+90 days"
    scope: "100 products"
    automation: "semi_autonomous"  # Flag edge cases for human review
    frequency: "daily"

  phase_3:
    timeline: "T+180 days"
    scope: "all_products"
    automation: "fully_autonomous"
    frequency: "real_time"
    kill_switch: "automatic_gate_failures"

monitoring:
  slos:
    - "Apex Index calculation latency < 2 seconds"
    - "Gate enforcement accuracy >= 99.9%"
    - "Zero false negatives on compliance violations"
    - "Weekly public ledger published on schedule"

  alerts:
    - condition: "compliance_score < 80"
      action: "immediate_slack_alert + vendor_notification"
    - condition: "trust_score < 70"
      action: "flag_for_review + pause_new_orders"
    - condition: "roi_per_day < 0 for 7 consecutive days"
      action: "sunset_product + refund_prepaid_subscriptions"
```

---

**File**: `/ops/metrics/apex_index_v1.yaml`
**Status**: Production-ready
**Integration**: Herbitrage Terminal (ROI/$/Day), LSS Truth Panel (analytics), Receipts-First KB (COA/trust data)
**Next**: Deploy to pilot products (Week 1-4)
