<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Texas COA Checker - Full Panel Validation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2C5F2D 0%, #1a3a1b 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #BF5700 0%, #8B3E00 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .license-badge {
            display: inline-block;
            background: #FFB81C;
            color: #333;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .content {
            padding: 30px;
        }
        
        .upload-section {
            border: 3px dashed #2C5F2D;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
        }
        
        .upload-section:hover {
            border-color: #BF5700;
            background: #f9f9f9;
        }
        
        .upload-icon {
            font-size: 4em;
            color: #2C5F2D;
            margin-bottom: 20px;
        }
        
        .btn {
            background: #2C5F2D;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
        }
        
        .btn:hover {
            background: #BF5700;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-secondary {
            background: #FFB81C;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #BF5700;
            color: white;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2C5F2D;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #2C5F2D;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 20px auto;
            display: none;
        }
        
        video {
            width: 100%;
            border-radius: 10px;
            border: 3px solid #2C5F2D;
        }
        
        .capture-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #BF5700;
            border: 5px solid white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .capture-btn:hover {
            transform: translateX(-50%) scale(1.1);
            box-shadow: 0 0 20px rgba(191, 87, 0, 0.5);
        }
        
        .results {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: #f9f9f9;
            border-radius: 10px;
        }
        
        .result-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 5px solid #2C5F2D;
        }
        
        .result-item.warning {
            border-left-color: #FFB81C;
        }
        
        .result-item.error {
            border-left-color: #C41E3A;
        }
        
        .result-item h3 {
            color: #2C5F2D;
            margin-bottom: 10px;
        }
        
        .cannabinoid-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .cannabinoid-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .cannabinoid-card .name {
            font-weight: 600;
            color: #2C5F2D;
            margin-bottom: 5px;
        }
        
        .cannabinoid-card .value {
            font-size: 1.5em;
            color: #BF5700;
        }
        
        .compliance-badge {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.2em;
            margin: 10px 0;
        }
        
        .compliance-badge.pass {
            background: #2C5F2D;
            color: white;
        }
        
        .compliance-badge.fail {
            background: #C41E3A;
            color: white;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2C5F2D;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .qr-section {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåø Texas COA Checker</h1>
            <p>Full Panel Certificate of Analysis Validation</p>
            <span class="license-badge">Texas DSHS License #690</span>
        </div>
        
        <div class="content">
            <!-- Upload Section -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">üìÑ</div>
                <h2>Upload Your Certificate of Analysis</h2>
                <p style="margin: 20px 0; color: #666;">
                    Upload a PDF or take a photo with your phone camera
                </p>
                
                <input type="file" id="fileInput" accept=".pdf,image/*">
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    üìÅ Choose File
                </button>
                <button class="btn btn-secondary" onclick="startCamera()">
                    üì∏ Use Camera
                </button>
            </div>
            
            <!-- Camera Section -->
            <div class="video-container" id="cameraSection">
                <video id="video" autoplay playsinline></video>
                <div class="capture-btn" onclick="capturePhoto()"></div>
                <button class="btn" onclick="stopCamera()" style="margin-top: 10px; width: 100%;">
                    ‚ùå Close Camera
                </button>
            </div>
            
            <!-- Form Section -->
            <div id="formSection" style="display: none; margin-top: 30px;">
                <div class="form-group">
                    <label for="sku">Product SKU *</label>
                    <input type="text" id="sku" placeholder="e.g., CBD-FLOWER-001" required>
                </div>
                
                <div class="form-group">
                    <label for="batch">Batch Number *</label>
                    <input type="text" id="batch" placeholder="e.g., BATCH-2025-001" required>
                </div>
                
                <div class="form-group">
                    <label for="labName">Lab Name (Optional)</label>
                    <input type="text" id="labName" placeholder="e.g., KCA Labs">
                </div>
                
                <button class="btn" onclick="submitCOA()" style="width: 100%;">
                    ‚úÖ Validate COA
                </button>
            </div>
            
            <!-- Loading Section -->
            <div class="loading" id="loadingSection">
                <div class="spinner"></div>
                <h3>Analyzing COA...</h3>
                <p>Validating against Texas Full Panel standards</p>
            </div>
            
            <!-- Results Section -->
            <div class="results" id="resultsSection">
                <h2>Validation Results</h2>
                
                <div class="result-item">
                    <h3>Texas Compliance Status</h3>
                    <div id="complianceStatus"></div>
                </div>
                
                <div class="result-item">
                    <h3>Validation Flags</h3>
                    <div id="validationFlags"></div>
                </div>
                
                <div class="result-item">
                    <h3>Cannabinoid Panel</h3>
                    <div class="cannabinoid-grid" id="cannabinoidGrid"></div>
                </div>
                
                <div class="result-item">
                    <h3>Contaminant Testing</h3>
                    <div id="contaminants"></div>
                </div>
                
                <div class="qr-section">
                    <h3>Verification QR Code</h3>
                    <p id="qrCode"></p>
                    <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                        Share this URL to verify COA authenticity
                    </p>
                </div>
                
                <button class="btn btn-secondary" onclick="resetForm()" style="width: 100%; margin-top: 20px;">
                    üîÑ Check Another COA
                </button>
            </div>
        </div>
        
        <div class="footer">
            <p><strong>Texas Full Panel Standard</strong> - Based on KCA Labs Template</p>
            <p>‚â§0.3% Total THC | NIST-Validated Methods Required for Novel Cannabinoids</p>
            <p style="margin-top: 10px;">
                <em>No medical claims. 21+ only. For compliance verification purposes.</em>
            </p>
        </div>
    </div>
    
    <canvas id="canvas" style="display: none;"></canvas>
    
    <script>
        let stream = null;
        let capturedFile = null;
        
        // File input handler
        document.getElementById('fileInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                capturedFile = e.target.files[0];
                document.getElementById('formSection').style.display = 'block';
                document.getElementById('uploadSection').style.display = 'none';
            }
        });
        
        // Start camera
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } // Use back camera on mobile
                });
                document.getElementById('video').srcObject = stream;
                document.getElementById('cameraSection').style.display = 'block';
                document.getElementById('uploadSection').style.display = 'none';
            } catch (err) {
                alert('Camera access denied or not available. Please use file upload instead.');
                console.error('Camera error:', err);
            }
        }
        
        // Capture photo
        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            canvas.toBlob(function(blob) {
                capturedFile = new File([blob], 'coa-scan.jpg', { type: 'image/jpeg' });
                stopCamera();
                document.getElementById('formSection').style.display = 'block';
                alert('Photo captured! Please fill in the details below.');
            }, 'image/jpeg');
        }
        
        // Stop camera
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            document.getElementById('cameraSection').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'block';
        }
        
        // Submit COA
        async function submitCOA() {
            const sku = document.getElementById('sku').value;
            const batch = document.getElementById('batch').value;
            const labName = document.getElementById('labName').value;
            
            if (!sku || !batch) {
                alert('Please fill in SKU and Batch Number');
                return;
            }
            
            if (!capturedFile) {
                alert('Please upload a COA or take a photo');
                return;
            }
            
            // Show loading
            document.getElementById('formSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';
            
            // Create form data
            const formData = new FormData();
            formData.append('file', capturedFile);
            formData.append('sku', sku);
            formData.append('batch', batch);
            if (labName) formData.append('lab_name', labName);
            
            try {
                // Call backend API
                const response = await fetch('/api/v1/coa/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('COA validation failed');
                }
                
                const result = await response.json();
                displayResults(result);
                
            } catch (error) {
                alert('Error processing COA: ' + error.message);
                console.error('Error:', error);
                resetForm();
            }
        }
        
        // Display results
        function displayResults(result) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            
            // Compliance status
            const complianceHTML = `
                <div class="compliance-badge ${result.texas_compliant ? 'pass' : 'fail'}">
                    ${result.texas_compliant ? '‚úÖ TEXAS COMPLIANT' : '‚ùå NON-COMPLIANT'}
                </div>
                <p style="margin-top: 10px;">
                    <strong>Total THC:</strong> ${result.total_thc}% (Max: 0.3%)
                </p>
                <p>
                    <strong>NIST Validated:</strong> ${result.nist_validated ? 'Yes ‚úÖ' : 'No ‚ùå'}
                </p>
                <p>
                    <strong>Novel Cannabinoid:</strong> ${result.novel_cannabinoid ? 'Yes ‚ö†Ô∏è' : 'No'}
                </p>
            `;
            document.getElementById('complianceStatus').innerHTML = complianceHTML;
            
            // Validation flags
            const flagsHTML = result.validation_flags.map(flag => 
                `<p style="margin: 5px 0;">${flag}</p>`
            ).join('');
            document.getElementById('validationFlags').innerHTML = flagsHTML;
            
            // Cannabinoids
            const cannabinoidHTML = Object.entries(result.cannabinoids).map(([name, value]) => `
                <div class="cannabinoid-card">
                    <div class="name">${name}</div>
                    <div class="value">${value.toFixed(2)}%</div>
                </div>
            `).join('');
            document.getElementById('cannabinoidGrid').innerHTML = cannabinoidHTML;
            
            // Contaminants
            const contaminantHTML = `
                <p><strong>Heavy Metals:</strong> ${Object.keys(result.contaminants.heavy_metals).length} tests</p>
                <p><strong>Microbial:</strong> ${Object.keys(result.contaminants.microbial).length} tests</p>
            `;
            document.getElementById('contaminants').innerHTML = contaminantHTML;
            
            // QR Code
            document.getElementById('qrCode').innerHTML = `
                <a href="${result.qr_code}" target="_blank" style="color: #2C5F2D; font-weight: bold;">
                    ${result.qr_code}
                </a>
            `;
        }
        
        // Reset form
        function resetForm() {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('formSection').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'block';
            
            document.getElementById('sku').value = '';
            document.getElementById('batch').value = '';
            document.getElementById('labName').value = '';
            document.getElementById('fileInput').value = '';
            capturedFile = null;
        }
    </script>
</body>
</html>
