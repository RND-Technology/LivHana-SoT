#!/bin/bash
# LIV - Universal Command Wrapper for LivHana System
# Usage: ./liv <command>

set -e

TIMESTAMP=$(date "+%Y-%m-%d %H:%M UTC")
ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

case "${1:-help}" in
  upgrade|evolve|update)
    echo "ðŸš€ LIV SYSTEM UPGRADE"
    echo "Timestamp: $TIMESTAMP"
    echo ""

    # Update timestamps in all key files
    echo "â° Synchronizing timestamps..."

    # Update START.sh
    sed -i.bak "s/VERIFIED AND UPDATED: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\} [0-9]\{2\}:[0-9]\{2\}/VERIFIED AND UPDATED: $TIMESTAMP/g" "$ROOT/START.sh"

    # Update STATUS.md
    sed -i.bak "s/Last Updated\*\*: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\} [0-9]\{2\}:[0-9]\{2\} UTC/Last Updated**: $TIMESTAMP/g" "$ROOT/STATUS.md"

    # Update milestones in STATUS.md
    sed -i.bak "s/### [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\} [0-9]\{2\}:[0-9]\{2\}/### $TIMESTAMP/g" "$ROOT/STATUS.md"

    # Clean up backup files
    rm -f "$ROOT/START.sh.bak" "$ROOT/STATUS.md.bak"

    echo "âœ… Timestamps synchronized: $TIMESTAMP"
    echo "âœ… START.sh updated"
    echo "âœ… STATUS.md updated"
    echo ""
    echo "ðŸŽ¯ System ready for next evolution"
    ;;

  status|health|check)
    echo "ðŸ“Š LIV SYSTEM STATUS"
    echo ""

    # Check agents
    RUNNING=$(tmux ls 2>/dev/null | grep -E "planning|research|artifact|execmon|qa" | wc -l | tr -d ' ')
    echo "Agents: $RUNNING/5 running"

    # Check voice services
    if lsof -i :2022 2>/dev/null | grep -q LISTEN; then
      echo "STT (Whisper): âœ… Port 2022"
    else
      echo "STT (Whisper): âŒ Down"
    fi

    if lsof -i :8880 2>/dev/null | grep -q LISTEN; then
      echo "TTS (Kokoro): âœ… Port 8880"
    else
      echo "TTS (Kokoro): âŒ Down"
    fi

    # Check autonomous processes
    if [ -f "$ROOT/tmp/self_listen.pid" ] && kill -0 $(cat "$ROOT/tmp/self_listen.pid") 2>/dev/null; then
      echo "Self-Listen: âœ… Active"
    else
      echo "Self-Listen: âŒ Inactive"
    fi

    if [ -f "$ROOT/tmp/self_improve.pid" ] && kill -0 $(cat "$ROOT/tmp/self_improve.pid") 2>/dev/null; then
      echo "Self-Improve: âœ… Active"
    else
      echo "Self-Improve: âŒ Inactive"
    fi

    echo ""
    echo "Last Updated: $(grep 'Last Updated' "$ROOT/STATUS.md" | head -1)"
    ;;

  logs|tail)
    echo "ðŸ“œ LIV SYSTEM LOGS (last 20 lines)"
    echo ""
    echo "=== SELF-LISTEN ==="
    tail -20 "$ROOT/logs/autonomous/self_listen.log" 2>/dev/null || echo "No logs yet"
    echo ""
    echo "=== SELF-IMPROVE ==="
    tail -20 "$ROOT/logs/autonomous/self_improve.log" 2>/dev/null || echo "No logs yet"
    ;;

  help|*)
    echo "LIV - Universal Command Wrapper"
    echo ""
    echo "Usage: ./liv <command>"
    echo ""
    echo "Commands:"
    echo "  upgrade, evolve, update  - Sync timestamps across all system files"
    echo "  status, health, check    - Show system health and agent status"
    echo "  logs, tail               - View recent autonomous system logs"
    echo "  help                     - Show this help message"
    echo ""
    echo "Examples:"
    echo "  ./liv upgrade    # Update all timestamps to current time"
    echo "  ./liv status     # Check system health"
    echo "  ./liv logs       # View recent logs"
    ;;
esac
