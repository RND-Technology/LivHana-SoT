<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üî• Talk to Claude - WebSocket Voice</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 800px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
      color: #333;
      font-size: 2.5em;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 1.1em;
    }

    .status {
      background: #f0f0f0;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: bold;
    }

    .status.connected { background: #d4edda; color: #155724; }
    .status.listening { background: #fff3cd; color: #856404; }
    .status.transcribing { background: #cce5ff; color: #004085; }
    .status.thinking { background: #e2d5f8; color: #4a148c; }
    .status.speaking { background: #ffe5cc; color: #cc5200; }
    .status.error { background: #f8d7da; color: #721c24; }

    .controls {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
    }

    button {
      padding: 15px 30px;
      font-size: 1.1em;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    button:active {
      transform: translateY(0);
    }

    #connectBtn {
      background: #28a745;
      color: white;
    }

    #recordBtn {
      background: #007bff;
      color: white;
    }

    #recordBtn.recording {
      background: #dc3545;
      animation: pulse 1.5s infinite;
    }

    #interruptBtn {
      background: #ffc107;
      color: #333;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .conversation {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .message {
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 10px;
      max-width: 80%;
    }

    .message.user {
      background: #007bff;
      color: white;
      margin-left: auto;
      text-align: right;
    }

    .message.assistant {
      background: #e9ecef;
      color: #333;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .metric {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }

    .metric-value {
      font-size: 1.8em;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }

    .metric-label {
      font-size: 0.9em;
      color: #666;
    }

    .config {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .config h3 {
      margin-bottom: 15px;
      color: #333;
    }

    .config-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .config-item label {
      font-weight: bold;
      color: #666;
    }

    .config-item input[type="range"] {
      width: 200px;
    }

    .config-item input[type="text"] {
      padding: 5px 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    audio {
      width: 100%;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üî• Talk to Claude</h1>
    <p class="subtitle">Real-Time WebSocket Voice - Powered by Whisper + Claude + Vocode</p>

    <div id="status" class="status">Not connected</div>

    <div class="controls">
      <button id="connectBtn" onclick="connect()">Connect</button>
      <button id="recordBtn" onclick="toggleRecording()" disabled>üé§ Start Recording</button>
      <button id="interruptBtn" onclick="interrupt()" disabled>‚ö†Ô∏è Interrupt</button>
    </div>

    <div class="conversation" id="conversation">
      <p style="text-align: center; color: #999;">Conversation will appear here...</p>
    </div>

    <div class="metrics">
      <div class="metric">
        <div class="metric-value" id="latencyValue">0</div>
        <div class="metric-label">Latency (ms)</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="messagesValue">0</div>
        <div class="metric-label">Messages</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="interruptValue">0</div>
        <div class="metric-label">Interrupts</div>
      </div>
    </div>

    <div class="config">
      <h3>Voice Configuration</h3>
      <div class="config-item">
        <label>Speed:</label>
        <input type="range" id="speedSlider" min="0.5" max="2" step="0.1" value="1.0" onchange="updateConfig()">
        <span id="speedValue">1.0x</span>
      </div>
      <div class="config-item">
        <label>Pitch:</label>
        <input type="range" id="pitchSlider" min="0.5" max="2" step="0.1" value="1.0" onchange="updateConfig()">
        <span id="pitchValue">1.0x</span>
      </div>
      <div class="config-item">
        <label>Stability:</label>
        <input type="range" id="stabilitySlider" min="0" max="1" step="0.05" value="0.75" onchange="updateConfig()">
        <span id="stabilityValue">0.75</span>
      </div>
    </div>

    <audio id="audioPlayer" controls style="display:none;"></audio>
  </div>

  <script>
    let ws = null;
    let mediaRecorder = null;
    let audioContext = null;
    let isRecording = false;
    let audioChunks = [];
    let messageCount = 0;
    let interruptCount = 0;
    let lastLatency = 0;

    const status = document.getElementById('status');
    const conversation = document.getElementById('conversation');
    const connectBtn = document.getElementById('connectBtn');
    const recordBtn = document.getElementById('recordBtn');
    const interruptBtn = document.getElementById('interruptBtn');

    function updateStatus(text, className) {
      status.textContent = text;
      status.className = 'status ' + className;
    }

    function addMessage(role, text) {
      const msg = document.createElement('div');
      msg.className = 'message ' + role;
      msg.textContent = text;
      conversation.appendChild(msg);
      conversation.scrollTop = conversation.scrollHeight;
      messageCount++;
      document.getElementById('messagesValue').textContent = messageCount;
    }

    async function connect() {
      try {
        // Connect to WebSocket
        ws = new WebSocket('ws://localhost:8080/ws/voice');

        ws.onopen = () => {
          updateStatus('Connected! Ready to talk to Claude', 'connected');
          connectBtn.disabled = true;
          recordBtn.disabled = false;
          interruptBtn.disabled = false;
        };

        ws.onmessage = async (event) => {
          // Check if binary audio data
          if (event.data instanceof Blob) {
            playAudio(event.data);
            return;
          }

          // Parse JSON message
          const message = JSON.parse(event.data);
          console.log('Received:', message);

          switch (message.type) {
            case 'connected':
              console.log('Session ID:', message.data.session_id);
              break;

            case 'transcribed':
              updateStatus(`Transcribed: "${message.data.text}"`, 'transcribing');
              addMessage('user', message.data.text);
              lastLatency = message.data.latency_ms;
              document.getElementById('latencyValue').textContent = lastLatency;
              break;

            case 'thinking':
              updateStatus('Claude is thinking...', 'thinking');
              break;

            case 'response_chunk':
              updateStatus('Claude is responding...', 'thinking');
              break;

            case 'response_complete':
              updateStatus('Claude responded!', 'connected');
              addMessage('assistant', message.data.text);
              lastLatency = message.data.latency_ms;
              document.getElementById('latencyValue').textContent = lastLatency;
              break;

            case 'speaking_started':
              updateStatus('Playing voice response...', 'speaking');
              break;

            case 'speaking_complete':
              updateStatus('Ready to talk', 'connected');
              break;

            case 'interrupted':
              updateStatus('Interrupted!', 'connected');
              interruptCount = message.data.count;
              document.getElementById('interruptValue').textContent = interruptCount;
              break;

            case 'error':
              updateStatus('Error: ' + message.data.message, 'error');
              console.error('Error:', message.data);
              break;
          }
        };

        ws.onerror = (error) => {
          updateStatus('WebSocket error', 'error');
          console.error('WebSocket error:', error);
        };

        ws.onclose = () => {
          updateStatus('Disconnected', 'error');
          connectBtn.disabled = false;
          recordBtn.disabled = true;
          interruptBtn.disabled = true;
        };

      } catch (error) {
        console.error('Connection error:', error);
        updateStatus('Failed to connect: ' + error.message, 'error');
      }
    }

    async function toggleRecording() {
      if (!isRecording) {
        await startRecording();
      } else {
        stopRecording();
      }
    }

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: {
            channelCount: 1,
            sampleRate: 16000
          }
        });

        audioContext = new AudioContext({ sampleRate: 16000 });
        const source = audioContext.createMediaStreamSource(stream);
        const processor = audioContext.createScriptProcessor(4096, 1, 1);

        processor.onaudioprocess = (e) => {
          if (!isRecording) return;

          const audioData = e.inputBuffer.getChannelData(0);
          const int16Array = new Int16Array(audioData.length);

          // Convert float32 to int16
          for (let i = 0; i < audioData.length; i++) {
            const s = Math.max(-1, Math.min(1, audioData[i]));
            int16Array[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
          }

          // Send to server
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(int16Array.buffer);
          }
        };

        source.connect(processor);
        processor.connect(audioContext.destination);

        isRecording = true;
        recordBtn.textContent = '‚èπÔ∏è Stop Recording';
        recordBtn.classList.add('recording');
        updateStatus('Recording... Speak now!', 'listening');

      } catch (error) {
        console.error('Recording error:', error);
        updateStatus('Failed to start recording: ' + error.message, 'error');
      }
    }

    function stopRecording() {
      isRecording = false;
      if (audioContext) {
        audioContext.close();
      }
      recordBtn.textContent = 'üé§ Start Recording';
      recordBtn.classList.remove('recording');
      updateStatus('Recording stopped', 'connected');
    }

    function interrupt() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'interrupt' }));
      }
    }

    function updateConfig() {
      const speed = parseFloat(document.getElementById('speedSlider').value);
      const pitch = parseFloat(document.getElementById('pitchSlider').value);
      const stability = parseFloat(document.getElementById('stabilitySlider').value);

      document.getElementById('speedValue').textContent = speed + 'x';
      document.getElementById('pitchValue').textContent = pitch + 'x';
      document.getElementById('stabilityValue').textContent = stability;

      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'config',
          data: {
            voice_config: { speed, pitch, stability }
          }
        }));
      }
    }

    async function playAudio(blob) {
      const audioPlayer = document.getElementById('audioPlayer');
      const url = URL.createObjectURL(blob);
      audioPlayer.src = url;
      audioPlayer.play();
    }
  </script>
</body>
</html>
