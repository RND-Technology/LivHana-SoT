# ADR-002 — Voice Mode Queue Architecture & Guardrails

**Status:** Proposed • **Date:** 2025-09-28 • **Owner:** Liv Hana (Codex Tier‑1)

## 1. Context

- Voice Mode requires compliant routing between `frontend/vibe-cockpit`, `backend/voice-service` (ElevenLabs proxy), and `backend/reasoning-gateway` (DeepSeek 33B).
- Existing docs describe flows but no single ADR codifies queue design, guardrails, memory hooks, or feedback capture needed for 50k+ monthly transactions.

## 2. Decision

Adopt a shared voice/reasoning queue architecture with the following pillars:

1. **BullMQ + Redis Isolation** — Queue `voice-mode-reasoning-jobs`, producers in voice-service, consumers in reasoning-gateway.
2. **JWT & Guardrails Everywhere** — All inbound requests pass through shared `authMiddleware`, guardrail filters (`common/guardrails`), banned-phrase checks.
3. **Memory & Feedback Hooks** — `common/memory/store` persists job history (Redis + in-memory fallback); `common/feedback` logs per-job outcomes for future learning.
4. **SSE Streaming + Progress Updates** — Reasoning gateway uses `streamJobEvents` + progress events to stream partial deltas to frontend.
5. **Logging & Observability** — Pino structured logs with request IDs, queue events tracked via `automation/scripts/check_service_health.sh`.

## 3. Consequences

- Enables detached scaling (voice-service can burst without overloading reasoning workers).
- Guardrail enforcement prior to DeepSeek invocation reduces compliance risk.
- Memory footprint manageable via Redis TTL + fallback for local dev.
- Requires operational ownership of Redis (managed or dockerized cluster).

## 4. Implementation Snapshot

- Producers: `voice-router.js` handles `/reasoning/enqueue`, `/reasoning/result/:id`, `/reasoning/stream/:id`.
- Consumers: `createDeepSeekWorkerProcessor` streams results, appends memory, records feedback, updates BullMQ progress.
- Shared modules: `common/queue`, `common/guardrails`, `common/memory`, `common/feedback`.
- Documentation: `docs/voice/ElevenLabs_v3_upgrade.md`, `docs/reasoning/deepseek_33b_local.md` reference this ADR.

## 5. Risks & Mitigations

- **Redis outage** → in-memory fallback, queue depth monitoring via health scripts.
- **Long-running jobs** → BullMQ job timeout env vars + progress heartbeats.
- **Compliance drift** → guardrail filters maintain banned phrase list via env vars, future addition of policy classifiers.

## 6. Acceptance Criteria

- Queue endpoints respond (health script passes).
- Guardrails logged (allowed/blocked) per job.
- Memory/feedback logs generated for each reasoning completion.
- New Playwright deterministic mocks cover enqueue → stream → final flow.

<!-- Last verified: 2025-10-02 -->

<!-- Optimized: 2025-10-02 -->
