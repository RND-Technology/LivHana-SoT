---
diataxis: explanation
owner: Liv Hana (Codex Tier‑1)
adr: ADR-002
last-reviewed: 2025-10-06
status: accepted
---

# ADR-002: Voice Mode Queue Architecture & Guardrails

## Status
Accepted

## Context
Voice Mode requires compliant routing between `frontend/vibe-cockpit`, `backend/voice-service` (ElevenLabs proxy), and `backend/reasoning-gateway` (DeepSeek 33B). The current architecture lacks proper queue management and guardrails for voice interactions.

## Decision

Adopt a shared voice/reasoning queue architecture with the following pillars:

1. **BullMQ + Redis Isolation** — Queue `voice-mode-reasoning-jobs`, producers in voice-service, consumers in reasoning-gateway.
2. **JWT & Guardrails Everywhere** — All inbound requests pass through shared `authMiddleware`, guardrail filters (`common/guardrails`), banned-phrase checks.
3. **Memory & Feedback Hooks** — `common/memory/store` persists job history (Redis + in-memory fallback); `common/feedback` logs per-job outcomes for future learning.
4. **SSE Streaming + Progress Updates** — Reasoning gateway uses `streamJobEvents` + progress events to stream partial deltas to frontend.
5. **Logging & Observability** — Pino structured logs with request IDs, queue events tracked via `automation/scripts/check_service_health.sh`.

## Consequences

### Positive
- Enables detached scaling (voice-service can burst without overloading reasoning workers)
- Guardrail enforcement prior to DeepSeek invocation reduces compliance risk
- Memory footprint manageable via Redis TTL + fallback for local dev
- Scalable architecture for 50k+ monthly transactions

### Negative
- Requires operational ownership of Redis (managed or dockerized cluster)
- Increased complexity in queue management
- Additional infrastructure overhead

## Implementation Snapshot

- Producers: `voice-router.js` handles `/reasoning/enqueue`, `/reasoning/result/:id`, `/reasoning/stream/:id`
- Consumers: `createDeepSeekWorkerProcessor` streams results, appends memory, records feedback, updates BullMQ progress
- Shared modules: `common/queue`, `common/guardrails`, `common/memory`, `common/feedback`
- Documentation: `docs/voice/ElevenLabs_v3_upgrade.md`, `docs/reasoning/deepseek_33b_local.md` reference this ADR

## Risks & Mitigations

- **Redis outage** → in-memory fallback, queue depth monitoring via health scripts
- **Long-running jobs** → BullMQ job timeout env vars + progress heartbeats
- **Compliance drift** → guardrail filters maintain banned phrase list via env vars, future addition of policy classifiers

## Acceptance Criteria

- Queue endpoints respond (health script passes)
- Guardrails logged (allowed/blocked) per job
- Memory/feedback logs generated for each reasoning completion
- New Playwright deterministic mocks cover enqueue → stream → final flow

<!-- Last verified: 2025-10-02 -->

<!-- Optimized: 2025-10-02 -->

<!-- Last updated: 2025-10-02 -->

<!-- Last optimized: 2025-10-02 -->
