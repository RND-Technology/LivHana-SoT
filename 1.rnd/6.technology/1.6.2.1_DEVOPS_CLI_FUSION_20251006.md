<!-- Optimized: 2025-10-06 -->
<!-- RPM: 1.6.2.1.1.6.2.1_DEVOPS_CLI_FUSION_20251006 -->
<!-- Session: E2E RPM DNA Application -->
<!-- AOM: RND (Reggie & Dro) -->
<!-- COI: TECHNOLOGY -->
<!-- RPM: HIGH -->
<!-- ACTION: BUILD -->

# DEVOPS_CLI_FUSION • FUSION DOC

**Source:** CLAUDE_CODE_CLI_IMPLEMENTATION_GUIDE.md
**Fused:** 2025-10-03 18:40 UTC
**Status:** ⚠️ ARCHITECTURE MISMATCH • REQUIRES TRANSLATION
**Next Action:** Map guide tasks → Trinity GCP infrastructure

---

## VISION VS REALITY

**Guide Assumption:** Direct LightSpeed/Square/SendGrid automation via CLI prompts
**Trinity Reality:** Multi-layer GCP infrastructure (Cloud Run, BigQuery, VPC connectors) must be deployed first

### What This Guide DOES Provide ✅

- Comprehensive task breakdown for e-commerce automation
- API endpoint specifications (verification check, order flagging, email triggers)
- Database schemas (customer_verification, order_verification_flags, loyalty systems)
- Email automation sequences (11 templates across 4 flows)
- Analytics dashboard architecture (metrics, visualizations, real-time updates)

### What This Guide CANNOT Execute (Without Translation) ⚠️

- **No Trinity awareness:** Guide assumes standalone Flask microservices, but Trinity uses:
  - `voice-service` (Cloud Run)
  - `reasoning-gateway` (Cloud Run)
  - `empire-cockpit` (frontend)
  - BigQuery (analytics, not PostgreSQL for transactional data)
- **No GCP deployment patterns:** Guide references Heroku/Docker, not Cloud Run with VPC connectors + Redis
- **No existing codebase integration:** Guide generates new code, but Trinity backend already exists at `/backend/` and `/empire/`

---

## FALLACY SCAN • CRITICAL GAPS

### 🔴 **BLOCKER #1: PostgreSQL vs BigQuery Confusion**

**Claim:** "Database: PostgreSQL 13+ with TimescaleDB for time-series"
**Reality:** Trinity uses BigQuery for analytics (`cannabis_data.lightspeed_products`, `cannabis_data.square_payments`)
**Evidence:** `.claude/SESSION_PROGRESS.md` shows BigQuery tables created, no PostgreSQL references

**Resolution Required:**

1. Determine transactional vs analytical split:
   - **Transactional** (verification flags, loyalty, orders pending): Use Cloud SQL (PostgreSQL) OR Firebase Realtime Database
   - **Analytical** (sales reports, funnel metrics, dashboard): Use BigQuery
2. Update all database schemas in guide to match chosen architecture
3. Build data pipeline: Cloud SQL → BigQuery (via Cloud Functions or Dataflow) for analytics

**Action:** Read existing backend code to confirm database strategy

```bash
grep -r "database\|db\|sql\|bigquery" backend/ empire/ --include="*.py" --include="*.ts" --include="*.js" | head -50
```

---

### 🔴 **BLOCKER #2: LightSpeed API Access Undefined**

**Claim:** "LightSpeed FTP credentials: [provide]" + "LightSpeed webstore API"
[REDACTED - SECURITY BREACH]
**Evidence:** `.env.master` file read earlier showed only GCP, Square, Veriff keys

**Resolution Required:**

1. Check 1Password for LightSpeed credentials: `op item get lightspeed` OR `op item get reggieanddro`
2. If LightSpeed API doesn't exist → Use manual theme editor (reggieanddro.company.site/admin)
3. Fallback: All "LightSpeed customization" tasks become manual HTML/CSS/JS injection via admin panel

**Validation Check:**

```bash
curl -X GET "https://api.lightspeedapp.com/API/Account/XXXXX/Category.json" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Accept: application/json"
```

If 401/403 → No API access → Manual workflow required

---

### 🔴 **BLOCKER #3: Square API Scope Insufficient**

**Claim:** "Square Refunds API + Catalog API + Customer API"
**Reality:** Square API token in 1Password may not have all required scopes

**Required Scopes for This Guide:**

- `ORDERS_READ`, `ORDERS_WRITE` (order flagging, refunds)
- `CUSTOMERS_READ`, `CUSTOMERS_WRITE` (verification status sync)
- `ITEMS_READ` (product catalog for emails)
- `PAYMENTS_WRITE_ADDITIONAL_RECIPIENTS` (if using Square for refunds)
- `MERCHANT_PROFILE_READ` (for business details in emails)

**Validation Check:**

```bash
# Test Square API access
curl https://connect.squareup.com/v2/customers \
  -H "Authorization: Bearer YOUR_SQUARE_ACCESS_TOKEN" \
  -H "Content-Type: application/json"
```

If scope error → Re-authorize Square app with additional permissions via Square Developer Console

---

### ⚠️ **DEPENDENCY #4: SendGrid Domain Authentication Unverified**

**Claim:** "SendGrid domain authentication (SPF, DKIM, DMARC)"
**Reality:** No evidence that reggieanddro.com has SendGrid DNS records configured

**Resolution Required:**

1. Provision SendGrid API key: `op item get sendgrid` OR create new account
2. Add DNS records to domain registrar (Cloudflare/Google Domains):
   - **SPF:** TXT record `v=spf1 include:sendgrid.net ~all`
   - **DKIM:** TXT records provided by SendGrid (2 records)
   - **DMARC:** TXT record `v=DMARC1; p=none; rua=mailto:postmaster@reggieanddro.com`
3. Verify authentication in SendGrid dashboard (takes 24-48hrs for DNS propagation)

**Evidence File:** `.evidence/2025-10-03/sendgrid/dns-records.txt`

---

### ⚠️ **CLAIM #5: "Claude Code CLI Automation" Reduces Timeline 50%+**

**Claimed Timeline:** 94 hours manual → 5-7 days with CLI automation
**Reality Check:** CLI can generate code faster, but deployment/testing/integration remains manual

**Actual Time Savings:**

- Code generation: 70% faster ✅
- API integration: 30% faster (still need to test endpoints, handle auth)
- Database setup: 50% faster (migrations auto-generated, but schema design requires human decisions)
- Testing: 10% faster (unit tests generated, but integration/E2E tests require manual validation)

**Revised Estimate:** 94 hours → ~60-70 hours with CLI assistance (not 40 hours)

---

## TASK TRANSLATION • TRINITY ARCHITECTURE

### ✅ **Task 1A: Age-Gate Modal → Manual Implementation**

**Why:** No LightSpeed FTP/API access confirmed yet
**Process:**

1. Access reggieanddro.company.site/admin (credentials in 1Password)
2. Navigate to: Themes → Customize → Edit HTML/CSS
3. Inject age-gate code (from TEXAS_TAKEOVER source doc, lines 44-97)
4. Test on staging URL (if available) before publishing
5. Screenshot evidence: `.evidence/2025-10-03/lightspeed-theme/age-gate-injected.png`

**CLI Prompt Adaptation:** N/A (manual task until API confirmed)

---

### ✅ **Task 1B: Hero Section → Manual Implementation**

**Why:** Same as 1A (no API access)
**Process:**

1. Create hero image: Texas flag + cannabis leaf (Canva or hire designer)
2. Upload to Cloudinary OR reggieanddro.com/email-assets/ (use existing hosting)
3. Inject hero HTML/CSS via LightSpeed theme editor
4. Add countdown timer JavaScript (from guide, lines 91-97 of TEXAS_TAKEOVER source)
5. Test mobile responsive design (iPhone 14, Samsung Galaxy S23)

**Evidence:** Screenshot + Lighthouse score (target: 90+) in `.evidence/2025-10-03/lightspeed-theme/hero-section.png`

---

### 🔴 **Task 2A: Customer Verification API → Build on Trinity Backend**

**Translation:** Don't build standalone Flask microservice → Extend existing Trinity backend

**Step 1: Locate Existing Backend**

```bash
find backend/ empire/ -name "*verif*" -o -name "*customer*" -o -name "*auth*" | head -20
```

**Step 2: Read Backend Architecture**

```bash
cat backend/README.md  # If exists
cat backend/package.json  # Check if Node.js backend
cat backend/requirements.txt  # Check if Python backend
```

**Step 3: Build Verification Endpoint**

- If Node.js (Express/Fastify): Add route in `backend/src/routes/customer.ts`
- If Python (Flask/FastAPI): Add route in `backend/app/routes/customer.py`
- Database: Use Cloud SQL (PostgreSQL) for transactional verification flags
- Schema: Follow guide's `customer_verification` table (lines 210-212)

**Deployment:**

```bash
# Deploy to Cloud Run
gcloud run deploy backend-api \
  --source backend/ \
  --region us-central1 \
  --allow-unauthenticated \
  --set-env-vars="DATABASE_URL=postgresql://...,SQUARE_API_KEY=..."
```

**Evidence:** `curl` test + logs in `.evidence/2025-10-03/api/verification-endpoint.txt`

---

### 🔴 **Task 2B: Order Flagging System → Integrate with Square Webhooks**

**Translation:** Use Square's existing webhook system, not custom polling

**Square Webhook Setup:**

1. Square Developer Console → Applications → [Your App] → Webhooks
2. Subscribe to events:
   - `order.created`
   - `payment.updated`
   - `refund.created`
3. Set webhook URL: `https://backend-api-XXXXX.run.app/webhooks/square`
4. Verify webhook signature (security requirement)

**Backend Implementation:**

```typescript
// backend/src/routes/webhooks.ts
app.post('/webhooks/square', async (req, res) => {
  // Verify Square signature
  const signature = req.headers['x-square-signature'];
  const isValid = verifySquareWebhook(req.body, signature, SQUARE_WEBHOOK_SECRET);
  if (!isValid) return res.status(401).send('Invalid signature');

  const event = req.body;
  if (event.type === 'order.created') {
    // Check customer verification status
    const customer = await checkVerification(event.data.object.customer_id);
    if (!customer.all_verified) {
      // Flag order + trigger email sequence
      await flagOrder(event.data.object.id, customer.email);
      await sendVerificationEmail(customer.email, event.data.object.id);
    }
  }
  res.status(200).send('OK');
});
```

**Evidence:** Webhook test via Square Dashboard + logs in `.evidence/2025-10-03/webhooks/square-order-created.txt`

---

### ✅ **Task 3A: Email Automation → Use Existing Templates**

**Translation:** Templates already created in EMAIL_CAMPAIGN_TEMPLATES.md → Load into SendGrid

**Process:**

1. Provision SendGrid API key (`op item get sendgrid`)
2. Create 11 dynamic templates in SendGrid UI:
   - Launch sequence (4 emails)
   - Verification reminders (4 emails)
   - Review request (1 email)
   - Abandoned cart (3 emails)
3. For each template:
   - Copy HTML from EMAIL_CAMPAIGN_TEMPLATES source doc
   - Add dynamic substitution tags ({{first_name}}, {{order_id}}, etc.)
   - Test template with sample data
   - Screenshot template ID + preview
4. Store template IDs in `.env`:

   ```
   SENDGRID_TEMPLATE_LAUNCH_1=d-xxxxxxxxxxxxx
   SENDGRID_TEMPLATE_LAUNCH_2=d-xxxxxxxxxxxxx
   ...
   ```

**Backend Integration:**

```typescript
// backend/src/services/email.ts
import sgMail from '@sendgrid/mail';
sgMail.setApiKey(process.env.SENDGRID_API_KEY);

export async function sendLaunchEmail(customer: Customer) {
  const msg = {
    to: customer.email,
    from: 'noreply@reggieanddro.com',
    templateId: process.env.SENDGRID_TEMPLATE_LAUNCH_1,
    dynamicTemplateData: {
      first_name: customer.first_name,
      loyalty_points: customer.loyalty_points,
      // ... other tokens
    },
  };
  await sgMail.send(msg);
}
```

**Evidence:** Test email screenshots + SendGrid delivery stats in `.evidence/2025-10-03/email/test-sends/`

---

### ⚠️ **Task 4A: Analytics Dashboard → Use BigQuery + Looker Studio (Not Custom React)**

**Translation:** Don't build custom React dashboard → Use GCP-native tools

**Why:**

- Trinity already uses BigQuery for analytics
- Looker Studio (free) integrates directly with BigQuery
- Faster to deploy than custom React + Flask backend
- Easier to maintain (no custom code to debug)

**Process:**

1. Set up BigQuery datasets (if not exists):

   ```sql
   CREATE SCHEMA IF NOT EXISTS reggieanddro_analytics;

   CREATE TABLE reggieanddro_analytics.daily_revenue (
     date DATE,
     revenue FLOAT64,
     orders INT64,
     aov FLOAT64
   );

   -- Populate via scheduled query (Cloud Scheduler → BigQuery)
   ```

2. Create Looker Studio dashboard:
   - Connect to BigQuery dataset
   - Add charts: Revenue trend, top products, conversion funnel
   - Share dashboard with team
   - Embed in empire-cockpit if needed (Looker Studio iframe)

3. Scheduled Data Updates:
   - Cloud Scheduler → Cloud Function → BigQuery INSERT
   - Runs every 15min to update metrics

**Evidence:** Looker Studio dashboard link + screenshot in `.evidence/2025-10-03/analytics/dashboard.png`

---

## NEXT ACTIONS • PRIORITIZED

### **P0: Resolve Database Architecture**

1. Read existing backend code to confirm database strategy

   ```bash
   grep -r "database\|client\|prisma\|sequelize" backend/ empire/ | head -30
   ```

2. If no transactional DB exists → Provision Cloud SQL (PostgreSQL)

   ```bash
   gcloud sql instances create reggieanddro-db \
     --database-version=POSTGRES_14 \
     --tier=db-f1-micro \
     --region=us-central1
   ```

3. Run migrations for verification tables (use Prisma or Alembic)
4. Update `.env` with `DATABASE_URL`

**Evidence:** Database connection test + schema dump in `.evidence/2025-10-03/database/`

---

### **P1: Verify API Access (LightSpeed, Square, SendGrid)**

1. LightSpeed:

   ```bash
   op item get lightspeed --fields label=api_key
   # If empty → Use manual theme editor workflow
   ```

2. Square:

   ```bash
   curl https://connect.squareup.com/v2/customers \
     -H "Authorization: Bearer $(op item get square-reggieanddro --fields label=access_token)"
   # Check scopes in response
   ```

3. SendGrid:

   ```bash
   op item get sendgrid --fields label=api_key
   # If empty → Create new account at sendgrid.com
   ```

**Evidence:** API test outputs in `.evidence/2025-10-03/api-validation/`

---

### **P1: Deploy Backend API Extensions**

1. Create `/backend/src/routes/verification.ts` (Customer verification endpoints)
2. Create `/backend/src/routes/orders.ts` (Order flagging system)
3. Create `/backend/src/services/email.ts` (SendGrid integration)
4. Add tests: `/backend/src/routes/__tests__/verification.test.ts`
5. Deploy to Cloud Run:

   ```bash
   gcloud run deploy backend-api --source backend/ --region us-central1
   ```

6. Update frontend env: `VITE_BACKEND_API_URL=https://backend-api-XXXXX.run.app`

**Evidence:** Deployment logs + health check in `.evidence/2025-10-03/backend-deploy/`

---

### **P2: Manual LightSpeed Customizations**

1. Age-gate modal injection (Task 1A process)
2. Hero section + countdown timer (Task 1B process)
3. Product page template updates (Task 1C process)
4. Test full customer journey: landing → cart → checkout → order confirmation
5. Run Lighthouse audit (target: 90+ performance, 100 accessibility)

**Evidence:** Screenshots + Lighthouse report in `.evidence/2025-10-03/lightspeed-theme/`

---

### **P2: Email Automation Setup**

1. Configure SendGrid domain auth (DNS records)
2. Create 11 dynamic templates
3. Implement email sending functions in backend
4. Set up CRON jobs (Cloud Scheduler):
   - Verification reminders: Check every hour for pending orders
   - Review requests: Check daily for delivered orders >7 days old
   - Abandoned cart: Check every 30min for carts >1hr old

**Evidence:** CRON job logs + test email deliveries in `.evidence/2025-10-03/email-automation/`

---

### **P3: Analytics Dashboard (Looker Studio)**

1. Create BigQuery scheduled queries (daily revenue, top products, funnel metrics)
2. Build Looker Studio dashboard (6 core visualizations from guide)
3. Embed dashboard in empire-cockpit (optional)
4. Set up alerts (Cloud Monitoring → Slack webhook if revenue <50% of target)

**Evidence:** Dashboard link + BigQuery query logs in `.evidence/2025-10-03/analytics/`

---

## VALIDATION CHECKLIST • PRE-LAUNCH

Before claiming "automation is live," run these tests:

### **Backend API Tests**

- [ ] `POST /api/v1/customer/check-verification` returns correct status for known customer
- [ ] `POST /api/v1/order/flag-verification` creates database record + triggers email
- [ ] `POST /api/v1/order/complete-verification` updates flag status + allows order to ship
- [ ] Square webhook handler processes `order.created` event correctly
- [ ] Email sending function delivers to real inbox (not spam folder)

### **LightSpeed Customizations**

- [ ] Age-gate modal appears on first visit, stores sessionStorage
- [ ] Hero countdown timer displays and updates every second
- [ ] Product pages show terpene profiles + COA expandables
- [ ] Loyalty points display in header ("XXX points = $XX off")
- [ ] Cart shows free shipping progress bar
- [ ] Checkout completes payment via Square

### **Email Automation**

- [ ] Verification reminder sequence sends at 15min, 24hr, 48hr, 72hr intervals
- [ ] Review request sends 7 days after tracking shows "delivered"
- [ ] Abandoned cart sequence sends at 1hr, 24hr, 48hr after abandonment
- [ ] All emails render correctly on mobile (Gmail app, iOS Mail)
- [ ] Unsubscribe link works and updates suppression list

### **Analytics Dashboard**

- [ ] Looker Studio dashboard loads in <5 seconds
- [ ] Revenue metrics update every 15min
- [ ] Top products table sortable and accurate
- [ ] Conversion funnel shows correct drop-off percentages
- [ ] Email campaign metrics match SendGrid stats

**Evidence Required:** Playwright test outputs + manual QA screenshots in `.evidence/2025-10-03/pre-launch/`

---

## MEMORY ANCHORS

**Key Files:**

- Source: `docs/incoming/2025-10-03/CLAUDE_CODE_CLI_IMPLEMENTATION_GUIDE.md`
- Fusion: `docs/fusion/devops/DEVOPS_CLI_FUSION.md` (this file)
- Task 1A-1C: LightSpeed customization prompts (lines 29-190 of source)
- Task 2A-2B: Square API integration prompts (lines 192-501 of source)
- Task 3A: Email automation setup (lines 504-643 of source)
- Task 4A: Analytics dashboard architecture (lines 645-814 of source)

**Dependencies:**

- Backend codebase: `/backend/` or `/empire/` (Trinity architecture)
- Database: Cloud SQL (PostgreSQL) for transactional + BigQuery for analytics
- LightSpeed credentials: 1Password `op://livhana/reggieanddro` OR manual admin access
- Square API token: 1Password `op://livhana/square-reggieanddro` (verify scopes)
- SendGrid API key: 1Password `op://livhana/sendgrid` OR provision new

**Translation Requirements:**

- All "Flask microservice" tasks → Extend existing Trinity backend (Node.js or Python)
- All "PostgreSQL" references → Cloud SQL (for transactional) + BigQuery (for analytics)
- All "LightSpeed API" tasks → Manual theme editor (until API confirmed)
- All "custom React dashboard" tasks → Looker Studio + BigQuery

---

## FINAL ASSESSMENT

**This guide is a Tier-1 task breakdown** but assumes greenfield architecture.
**Trinity reality:** Must integrate with existing GCP infrastructure + backend codebase.

**Critical Path:**

1. Resolve database architecture (P0) → Determines all subsequent API work
2. Verify API access (P1) → Determines manual vs automated workflow
3. Deploy backend extensions (P1) → Enables verification + email automation
4. Manual LightSpeed work (P2) → Unblocks webstore launch
5. Email automation (P2) → Drives customer engagement
6. Analytics dashboard (P3) → Provides visibility post-launch

**ETA to launch-ready:** 5-7 days (assumes database architecture resolved in Day 1).

**Recommended Path:**

1. Run backend code audit (identify existing DB + API patterns)
2. Provision Cloud SQL if needed (or use existing Trinity DB)
3. Build verification endpoints (follow guide's API specs)
4. Manual LightSpeed customizations (age-gate, hero, product pages)
5. SendGrid domain auth + template setup
6. Looker Studio dashboard (faster than custom React)
7. Full integration test (Playwright + manual QA)

**Logged:** 2025-10-03 18:40 UTC
**Fusion by:** Sonnet 4.5
**Next Fusion:** QUICK_START_ACTION_PLAN.md → EXEC_QUICK_START.md
