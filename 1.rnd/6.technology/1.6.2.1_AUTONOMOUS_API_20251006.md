<!-- Optimized: 2025-10-06 -->
<!-- RPM: 1.6.2.1.1.6.2.1_AUTONOMOUS_API_20251006 -->
<!-- Session: E2E RPM DNA Application -->
<!-- AOM: RND (Reggie & Dro) -->
<!-- COI: TECHNOLOGY -->
<!-- RPM: HIGH -->
<!-- ACTION: BUILD -->

# Claude Autonomous Agent API Documentation

## Overview

The Autonomous Agent API provides powerful endpoints for executing autonomous tasks, tracking progress in real-time, managing approvals, and learning from past executions. All endpoints require admin authentication.

**Base URL:** `http://localhost:4002/api/autonomous`

**Authentication:** All endpoints require JWT bearer token with admin role.

```bash
Authorization: Bearer <your-admin-jwt-token>
```

---

## Endpoints

### 1. Execute Task

Execute an autonomous task with AI-powered planning and execution.

**Endpoint:** `POST /api/autonomous/execute`

**Request Body:**

```json
{
  "task": "Add a new endpoint to handle user preferences",
  "context": {
    "service": "user-service",
    "database": "postgres",
    "requirements": [
      "Store user theme preference",
      "Include validation",
      "Add tests"
    ]
  },
  "requireApproval": true
}
```

**Response:** `202 Accepted`

```json
{
  "taskId": "550e8400-e29b-41d4-a716-446655440000",
  "status": "queued",
  "message": "Task queued for autonomous execution",
  "statusEndpoint": "/api/autonomous/tasks/550e8400-e29b-41d4-a716-446655440000",
  "streamEndpoint": "/api/autonomous/stream/550e8400-e29b-41d4-a716-446655440000"
}
```

**Example cURL:**

```bash
curl -X POST http://localhost:4002/api/autonomous/execute \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "task": "Fix the authentication bug in login endpoint",
    "context": {
      "errorLog": "JWT validation failing for refresh tokens",
      "affectedEndpoint": "/api/auth/refresh"
    },
    "requireApproval": false
  }'
```

---

### 2. Get Task Status

Retrieve current status, progress, and results of a task.

**Endpoint:** `GET /api/autonomous/tasks/:taskId`

**Response:** `200 OK`

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "task": "Add a new endpoint to handle user preferences",
  "status": "executing",
  "currentStep": "Step 3/5: write_file",
  "progress": 65,
  "completedSteps": 2,
  "eta": 45,
  "plan": {
    "totalSteps": 5,
    "steps": [
      { "action": "read_file", "target": "src/routes/user.js" },
      { "action": "write_file", "target": "src/routes/user.js" },
      { "action": "write_file", "target": "tests/user.test.js" },
      { "action": "run_tests", "target": "tests/user.test.js" },
      { "action": "execute_bash", "target": "npm run build" }
    ]
  },
  "createdBy": "admin-user-id",
  "createdAt": "2025-10-01T12:00:00.000Z",
  "updatedAt": "2025-10-01T12:02:30.000Z"
}
```

**Task Statuses:**

- `queued` - Task is waiting to be processed
- `analyzing` - AI is analyzing the task requirements
- `planning` - Creating execution plan
- `executing` - Actively executing the plan
- `verifying` - Verifying results
- `learning` - Learning from execution
- `pending_approval` - Waiting for human approval
- `approved` - Approved and deploying
- `completed` - Successfully completed
- `failed` - Execution failed
- `rejected` - Changes rejected by human
- `rolled_back` - Changes have been rolled back
- `cancelled` - Task was cancelled

**Example cURL:**

```bash
curl http://localhost:4002/api/autonomous/tasks/550e8400-e29b-41d4-a716-446655440000 \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

### 3. Stream Task Progress (Server-Sent Events)

Real-time streaming of task progress using SSE.

**Endpoint:** `GET /api/autonomous/stream/:taskId`

**Response:** `200 OK` (text/event-stream)

```
data: {"id":"550e8400...","status":"analyzing","progress":10,"currentStep":"Analyzing task requirements"}

data: {"id":"550e8400...","status":"planning","progress":25,"currentStep":"Creating execution plan"}

data: {"id":"550e8400...","status":"executing","progress":40,"currentStep":"Step 1/5: read_file"}

data: {"id":"550e8400...","status":"executing","progress":52,"currentStep":"Step 2/5: write_file"}

: heartbeat

data: {"id":"550e8400...","status":"completed","progress":100}
```

**Example JavaScript:**

```javascript
const eventSource = new EventSource(
  'http://localhost:4002/api/autonomous/stream/550e8400-e29b-41d4-a716-446655440000',
  {
    headers: {
      'Authorization': 'Bearer ' + adminToken
    }
  }
);

eventSource.onmessage = (event) => {
  const task = JSON.parse(event.data);
  console.log(`Progress: ${task.progress}% - ${task.currentStep}`);

  if (task.status === 'completed') {
    console.log('Task completed:', task.result);
    eventSource.close();
  }
};

eventSource.onerror = (error) => {
  console.error('SSE error:', error);
  eventSource.close();
};
```

**Example cURL:**

```bash
curl -N http://localhost:4002/api/autonomous/stream/550e8400-e29b-41d4-a716-446655440000 \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

### 4. Get Learnings

Retrieve patterns and insights learned from past task executions.

**Endpoint:** `GET /api/autonomous/learnings`

**Query Parameters:**

- `limit` (optional, default: 50) - Maximum number of learnings to return
- `successful` (optional) - Filter by success status (`true` or `false`)

**Response:** `200 OK`

```json
{
  "learnings": [
    {
      "id": "learning-123",
      "timestamp": "2025-10-01T12:00:00.000Z",
      "task": "Fix authentication bug",
      "success": true,
      "patterns": [
        "JWT validation requires checking both expiry and signature",
        "Refresh tokens should have separate validation logic",
        "Always test edge cases with expired tokens"
      ],
      "improvements": [
        "Add more comprehensive token validation",
        "Include refresh token tests in CI pipeline"
      ]
    }
  ],
  "total": 42,
  "returned": 1
}
```

**Example cURL:**

```bash
curl "http://localhost:4002/api/autonomous/learnings?limit=10&successful=true" \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

### 5. Get Agent Capabilities

Get comprehensive list of what the autonomous agent can do.

**Endpoint:** `GET /api/autonomous/capabilities`

**Response:** `200 OK`

```json
{
  "actions": [
    "read_file",
    "write_file",
    "execute_bash",
    "search_codebase",
    "run_tests",
    "deploy_code",
    "query_database",
    "analyze_logs",
    "generate_reports"
  ],
  "features": {
    "autonomousExecution": true,
    "selfHealing": true,
    "learningEngine": true,
    "rollbackSupport": true,
    "humanInTheLoop": true,
    "progressStreaming": true,
    "extendedThinking": true
  },
  "limits": {
    "maxTaskDuration": "10 minutes",
    "maxFileSize": "10MB",
    "supportedLanguages": ["JavaScript", "TypeScript", "Python", "SQL", "Bash"],
    "maxConcurrentTasks": 5
  },
  "integrations": {
    "bigQuery": true,
    "github": true,
    "redis": true,
    "anthropic": true
  }
}
```

**Example cURL:**

```bash
curl http://localhost:4002/api/autonomous/capabilities \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

### 6. Approve Changes (Human-in-the-Loop)

Approve or reject changes from a task execution before deployment.

**Endpoint:** `POST /api/autonomous/approve/:taskId`

**Request Body:**

```json
{
  "approved": true,
  "reason": "Changes look good, tests passing, ready for deployment"
}
```

**Response:** `200 OK`

```json
{
  "success": true,
  "message": "Changes approved and deployed",
  "task": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "status": "completed",
    "approvedBy": "admin-user-id",
    "approvedAt": "2025-10-01T12:05:00.000Z",
    "deployedAt": "2025-10-01T12:05:10.000Z"
  }
}
```

**Rejection Example:**

```json
{
  "approved": false,
  "reason": "Tests are failing, need to investigate further"
}
```

**Example cURL (Approve):**

```bash
curl -X POST http://localhost:4002/api/autonomous/approve/550e8400-e29b-41d4-a716-446655440000 \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "approved": true,
    "reason": "Looks good"
  }'
```

**Example cURL (Reject):**

```bash
curl -X POST http://localhost:4002/api/autonomous/approve/550e8400-e29b-41d4-a716-446655440000 \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "approved": false,
    "reason": "Need manual review of security implications"
  }'
```

---

### 7. Emergency Rollback

Rollback changes from a completed task execution.

**Endpoint:** `POST /api/autonomous/rollback/:taskId`

**Request Body:**

```json
{
  "reason": "Production bug introduced by this change"
}
```

**Response:** `200 OK`

```json
{
  "success": true,
  "message": "Task rolled back successfully",
  "changesReverted": [
    "src/routes/user.js",
    "tests/user.test.js"
  ],
  "task": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "status": "rolled_back",
    "rollbackInitiatedBy": "admin-user-id",
    "rolledBackAt": "2025-10-01T12:10:00.000Z"
  }
}
```

**Example cURL:**

```bash
curl -X POST http://localhost:4002/api/autonomous/rollback/550e8400-e29b-41d4-a716-446655440000 \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "reason": "Emergency rollback due to production issue"
  }'
```

---

### 8. List All Tasks

Get paginated list of all tasks with optional filtering.

**Endpoint:** `GET /api/autonomous/tasks`

**Query Parameters:**

- `status` (optional) - Filter by task status
- `limit` (optional, default: 50) - Number of results per page
- `offset` (optional, default: 0) - Pagination offset

**Response:** `200 OK`

```json
{
  "tasks": [
    {
      "id": "task-1",
      "task": "Fix authentication bug",
      "status": "completed",
      "createdAt": "2025-10-01T12:00:00.000Z",
      "completedAt": "2025-10-01T12:03:00.000Z"
    },
    {
      "id": "task-2",
      "task": "Add new endpoint",
      "status": "pending_approval",
      "createdAt": "2025-10-01T11:00:00.000Z"
    }
  ],
  "pagination": {
    "total": 150,
    "limit": 50,
    "offset": 0,
    "hasMore": true
  }
}
```

**Example cURL:**

```bash
curl "http://localhost:4002/api/autonomous/tasks?status=completed&limit=20" \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

### 9. Cancel Task

Cancel a queued or running task.

**Endpoint:** `DELETE /api/autonomous/tasks/:taskId`

**Response:** `200 OK`

```json
{
  "success": true,
  "message": "Task cancelled",
  "task": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "status": "cancelled",
    "cancelledBy": "admin-user-id",
    "cancelledAt": "2025-10-01T12:01:00.000Z"
  }
}
```

**Example cURL:**

```bash
curl -X DELETE http://localhost:4002/api/autonomous/tasks/550e8400-e29b-41d4-a716-446655440000 \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

### 10. Health Check

Check health status of the autonomous agent system.

**Endpoint:** `GET /api/autonomous/health`

**Response:** `200 OK`

```json
{
  "status": "healthy",
  "agent": {
    "initialized": true,
    "capabilities": 9,
    "apiKeyConfigured": true
  },
  "tasks": {
    "total": 150,
    "queued": 2,
    "running": 1,
    "pendingApproval": 3,
    "completed": 140
  },
  "learnings": {
    "total": 140,
    "successful": 135
  }
}
```

**Example cURL:**

```bash
curl http://localhost:4002/api/autonomous/health \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

---

## Complete Workflow Example

### 1. Execute a Task

```bash
TASK_ID=$(curl -X POST http://localhost:4002/api/autonomous/execute \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "task": "Add input validation to the user registration endpoint",
    "context": {
      "endpoint": "/api/auth/register",
      "validations": ["email format", "password strength", "username length"]
    },
    "requireApproval": true
  }' | jq -r '.taskId')

echo "Task ID: $TASK_ID"
```

### 2. Monitor Progress (Polling)

```bash
while true; do
  STATUS=$(curl -s http://localhost:4002/api/autonomous/tasks/$TASK_ID \
    -H "Authorization: Bearer $ADMIN_TOKEN" | jq -r '.status')

  echo "Status: $STATUS"

  if [[ "$STATUS" == "pending_approval" ]] || [[ "$STATUS" == "completed" ]] || [[ "$STATUS" == "failed" ]]; then
    break
  fi

  sleep 5
done
```

### 3. Review Results

```bash
curl http://localhost:4002/api/autonomous/tasks/$TASK_ID \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq
```

### 4. Approve Changes

```bash
curl -X POST http://localhost:4002/api/autonomous/approve/$TASK_ID \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "approved": true,
    "reason": "Validation logic looks correct, tests passing"
  }'
```

### 5. (If needed) Rollback

```bash
curl -X POST http://localhost:4002/api/autonomous/rollback/$TASK_ID \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "reason": "Found edge case bug in production"
  }'
```

---

## Error Handling

All endpoints return standard error responses:

**400 Bad Request:**

```json
{
  "error": "Task description is required"
}
```

**401 Unauthorized:**

```json
{
  "error": "Unauthorized"
}
```

**403 Forbidden:**

```json
{
  "error": "Forbidden",
  "message": "Admin access required"
}
```

**404 Not Found:**

```json
{
  "error": "Task not found"
}
```

**500 Internal Server Error:**

```json
{
  "error": "Task execution failed",
  "message": "Detailed error message"
}
```

---

## Environment Variables

Required configuration:

```bash
# Anthropic API
[REDACTED - SECURITY BREACH]

# JWT Configuration
JWT_SECRET=your-secret-key
JWT_AUDIENCE=livhana-api
JWT_ISSUER=livhana-auth

# Optional integrations
GOOGLE_APPLICATION_CREDENTIALS=/path/to/credentials.json
GITHUB_TOKEN=ghp_...
REDIS_URL=redis://localhost:6379
```

---

## Security Considerations

1. **Admin-Only Access**: All endpoints require admin role in JWT
2. **Human-in-the-Loop**: Use `requireApproval: true` for sensitive operations
3. **Rollback Support**: Emergency rollback available for all completed tasks
4. **Audit Trail**: All actions logged with user ID and timestamp
5. **Rate Limiting**: Consider implementing rate limits in production
6. **File Access**: Agent restricted to project directories
7. **Command Execution**: Bash commands run in sandboxed environment

---

## Best Practices

1. **Always use `requireApproval: true`** for production-affecting changes
2. **Monitor SSE streams** for real-time feedback during execution
3. **Review learnings regularly** to improve agent performance
4. **Test in development** before running autonomous tasks in production
5. **Keep rollback window short** - rollback immediately if issues detected
6. **Provide detailed context** in task descriptions for better results
7. **Set up alerts** for failed tasks
8. **Regular health checks** to monitor agent status

---

## Integration Examples

### React Frontend Component

```typescript
import { useState, useEffect } from 'react';

function AutonomousTaskMonitor({ taskId, authToken }) {
  const [task, setTask] = useState(null);

  useEffect(() => {
    const eventSource = new EventSource(
      `http://localhost:4002/api/autonomous/stream/${taskId}`,
      {
        headers: { 'Authorization': `Bearer ${authToken}` }
      }
    );

    eventSource.onmessage = (event) => {
      const updatedTask = JSON.parse(event.data);
      setTask(updatedTask);
    };

    return () => eventSource.close();
  }, [taskId, authToken]);

  if (!task) return <div>Loading...</div>;

  return (
    <div>
      <h2>Task: {task.task}</h2>
      <p>Status: {task.status}</p>
      <progress value={task.progress} max="100" />
      <p>{task.currentStep}</p>

      {task.status === 'pending_approval' && (
        <div>
          <button onClick={() => approveTask(taskId, true)}>Approve</button>
          <button onClick={() => approveTask(taskId, false)}>Reject</button>
        </div>
      )}
    </div>
  );
}
```

### Python CLI Tool

```python
import requests
import json
import time

class AutonomousAgentClient:
    def __init__(self, base_url, auth_token):
        self.base_url = base_url
        self.headers = {
            'Authorization': f'Bearer {auth_token}',
            'Content-Type': 'application/json'
        }

    def execute_task(self, task, context=None, require_approval=True):
        response = requests.post(
            f'{self.base_url}/api/autonomous/execute',
            headers=self.headers,
            json={
                'task': task,
                'context': context or {},
                'requireApproval': require_approval
            }
        )
        return response.json()

    def get_status(self, task_id):
        response = requests.get(
            f'{self.base_url}/api/autonomous/tasks/{task_id}',
            headers=self.headers
        )
        return response.json()

    def wait_for_completion(self, task_id, poll_interval=5):
        while True:
            status = self.get_status(task_id)
            print(f"Progress: {status['progress']}% - {status['currentStep']}")

            if status['status'] in ['completed', 'failed', 'pending_approval']:
                return status

            time.sleep(poll_interval)

# Usage
client = AutonomousAgentClient('http://localhost:4002', 'your-admin-token')
result = client.execute_task('Fix the login bug')
task_id = result['taskId']
final_status = client.wait_for_completion(task_id)
print(f"Task completed: {final_status}")
```

---

## Support

For issues or questions:

- Check health endpoint: `/api/autonomous/health`
- Review learnings: `/api/autonomous/learnings`
- Monitor logs in `reasoning-gateway` service
- Verify `ANTHROPIC_API_KEY` is configured correctly

<!-- Last verified: 2025-10-02 -->

<!-- Optimized: 2025-10-02 -->

<!-- Last updated: 2025-10-02 -->

<!-- Last optimized: 2025-10-02 -->
