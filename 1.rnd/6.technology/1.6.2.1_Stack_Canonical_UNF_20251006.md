<!-- Optimized: 2025-10-06 -->
<!-- RPM: 1.6.2.1.1.6.2.1_Stack_Canonical_UNF_20251006 -->
<!-- Session: E2E RPM DNA Application -->
<!-- AOM: RND (Reggie & Dro) -->
<!-- COI: TECHNOLOGY -->
<!-- RPM: HIGH -->
<!-- ACTION: BUILD -->

<!--
Optimized: 2025-10-03
RPM: 3.6.0.6.ops-technology-ship-status-documentation
Session: Dual-AI Collaboration - Sonnet Docs Sweep
-->

# Canonical Stack — UNF-2 (Hardened)

**Date:** 2025-09-13 • **Owner:** Jesse Niesen • **Maintainer:** Liv Hana (AI EA)**  
**Scope:** HNC / OPS / R&D / Herbitrage, single-cloud (GCP), single SoT, production-ready.

> Guardrails: **21+ only**, **no medical claims**, **natural cannabinoids only; NIST-validated** for any novel cannabinoids, **brands ≠ characters**, satire for public figures only.

---

## 1) Keep / Kill / Adopt Matrix (single source of truth)

### KEEP (Canonical)

- **Cloud Run** — API + Cockpit (Next.js)  
- **AlloyDB (Postgres 15)** — **sole OLTP** (replaces Supabase)  
- **BigQuery** — analytics tiles (ROI, funnel, policy KPIs)  
- **Cloud Storage (GCS)** — assets/COAs/brand packs  
- **Secret Manager** — all keys, rotated quarterly  
- **Cloud Scheduler** — daily kickoff & ops jobs  
- **Pub/Sub (optional)** — event fan-out; use when multi-consumer appears  
- **Monitoring & Logging** — SLOs, alerts, budgets  
- **Identity Platform** — 21+ age-gate; OIDC for cockpit

### ADOPT

- **Lightspeed** — POS/e-com target (migrate from Square)  
- **Vertex AI (eval/tooling)** — embeddings/evals as needed  
- **M4 MCP Orchestrator** — multi-agent planning/execution brain

### PHASE-OUT / CANCEL

- **Supabase** — **CANCEL** (OLTP → AlloyDB, Auth → Identity, Storage → GCS)  
- **Render** — **PHASE-OUT** (use Cloud Run)  
- **Zapier/Make/IFTTT** — **PHASE-OUT** (Cloud Workflows + Pub/Sub)  
- **Square** — **TRANSITION** to Lightspeed with 30-day dual-write max

---

## 2) Data Flows (text DAG)

```
Synthesia(input: script JSON) → render → Webhook → API → AlloyDB(videos) + GCS(url)  
Claude/OpenAI/Gemini → API → scripts/metadata → AlloyDB  
POS (Square→Lightspeed) → API → BigQuery (facts) → Cockpit tiles  
COAs/Compliance → GCS (versioned) → Cockpit validator (NIST-only flagging)  
Identity Platform(21+) → Cockpit auth → API OIDC → policy & store CTAs
```

---

## 3) Minimal Contracts

**API**  

- `POST /v1/video/kickoff` → `{topic, audience, durationSec}` → `{id, synthesiaId}`  
- `POST /v1/webhooks/synthesia` (HMAC) → `204`  
- `GET /api/roi` → `{ revenue, cost, roi, period }` (via BigQuery)  
- `GET /api/db/health` → `{ db_time }`  
- `GET /healthz` → `{ ok: true }`

**DB (AlloyDB)**  

- `videos(id, title, script, status, url, provider_id)`  
- `tpop(id, label, record jsonb, active)`  
- `tpop_metrics_daily(tpop_id, date, views, ctr_ops, signups_ops, joins_rd)`  
- `cockpit_prefs(user_id, settings jsonb)`

**Analytics (BigQuery)**  

- `fact_transactions` (source: POS)  
- `fact_content` (views, watch time)  
- `dim_channel`, `dim_tpop`, `dim_offer`  
- Materialized views for cockpit tiles

---

## 4) IAM & Keys (non-negotiable)

| Component | SA | Roles |
|---|---|---|
| API (Run) | `run-api@…` | `secretAccessor`, `bigquery.user`, `run.invoker` |
| Cockpit (Run) | `run-cockpit@…` | `secretAccessor`, `bigquery.readSessionUser`, `run.invoker` |
| Build | `build-bot@…` | `artifactregistry.writer`, `run.admin`, `iam.serviceAccountUser` |
| Scheduler | `ops-bot@…` | `run.invoker` |
| DB Migrate | `db-bot@…` | `secretAccessor` |

**Secrets** in Secret Manager:  
`anthropic_api_key`, `openai_api_key`, `gemini_api_key`, `synthesia_api_key`, `webhook_signing_secret`, `alloydb_user`, `alloydb_password`, `lightspeed_api_key`, (`square_access_token` during migration only).

---

## 5) Cost & Reliability Strategy

- **Budgets & Alerts:** 50% / 80% / 100% thresholds.  
- **SLOs:** API p95 < 400ms; availability 99.9%; error rate <1%.  
- **Backups:** AlloyDB PITR + nightly dump to multi-region GCS; BQ table snapshots.  
- **Cold-path disable:** Feature flags to disable Synthesia enqueue during incidents.

---

## 6) Compliance Overlay

- 21+ gate (Identity Platform) across cockpit & store; block underage sessions.  
- Compliance footer auto-injected: “21+ • No medical claims • Natural cannabinoids; NIST-validated methods.”  
- Brands are not characters; satire reserved for public figures.  
- COA uploads versioned; validator flags any non-NIST novel cannabinoid claims.

---

## 7) Replit-Ready Dev (so Replit can build/deploy)

**.replit** (Node/PNPM)

```
run = "pnpm -w dev"
```

**replit.nix**

```nix
{ pkgs }: {
  deps = [
    pkgs.nodejs_20
    pkgs.nodePackages.pnpm
    pkgs.postgresql
    pkgs.git
  ];
}
```

**Dev bootstrap**

```bash
pnpm i -w
pnpm -w build
pnpm -w dev
# local Postgres for dev parity; prod uses AlloyDB
createdb herbitrage || true
psql herbitrage < docs/AlloyDB_Schema.sql
```

**Deploy from Replit → GCP**  

- Use a Cloud Build trigger on `main`.  
- Push from Replit; Cloud Build builds & deploys Cloud Run (API + Cockpit).  
- Secrets pulled at runtime via Secret Manager.

---

## 8) Migration Plan (Supabase → AlloyDB; Square → Lightspeed)

**Supabase**  

- `pg_dump` data-only → `psql` into AlloyDB (Auth Proxy).  
- Remove Supabase keys; cancel project.  
**Square → Lightspeed**  
- Export catalog/customers → import to Lightspeed.  
- Dual-write window ≤ 30 days; then point-of-sale flips; deprecate Square APIs.

---

## 9) Acceptance Criteria (Stack-level)

- Cloud Run services up with custom domains.  
- AlloyDB reachable via proxy; `/api/db/health` returns timestamp.  
- Budget + SLO alerts visible in Monitoring.  
- Daily Scheduler job enqueues HNC render and completes via webhook within SLA.  
- No Supabase/Render/Zapier credentials exist in Secret Manager.

---

## 10) Appendix — Color/Brand Locks (for media surfaces)

- R&D Green `#16A34A`, Capitol Gold `#F59E0B`, Night Sky `#0F172A`, Cloud `#F8FAFC`.  
- Badges in corners only; no pot-leaf spam; lapel pin “R&D”.

**This file is canonical; earlier lists are superseded.**

<!-- Last verified: 2025-10-02 -->

<!-- Optimized: 2025-10-02 -->

<!-- Last updated: 2025-10-02 -->

<!-- Last optimized: 2025-10-02 -->
